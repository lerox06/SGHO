<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système de Gestion Hospitalier</title>
    <!-- Chargement de Tailwind CSS via CDN pour un stylisation moderne -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Styles personnalisés pour la police et la gestion du défilement */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Empêche le défilement global pour que la barre latérale fixe reste en place */
        }
        /* Masque les sections de module par défaut, seule la section active est visible */
        .module-section {
            display: none;
        }
        /* Affiche la section de module active */
        .module-section.active {
            display: block;
        }
        /* Style pour les messages de succès/erreur */
        .message-box {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
        }
        .message-box.success {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
            border: 1px solid #34d399; /* green-400 */
        }
        .message-box.error {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
            border: 1px solid #f87171; /* red-400 */
        }
        /* Masque le contenu principal de l'application par défaut */
        #app-content {
            display: none; /* TRÈS IMPORTANT : Masque par défaut */
        }
        /* Affiche le contenu principal lorsque l'utilisateur est connecté */
        #app-content.logged-in {
            display: flex;
        }
        .detail-card {
            background-color: #f9fafb; /* gray-50 */
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb; /* gray-200 */
            margin-bottom: 1rem;
        }
        .detail-card h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1f2937; /* gray-900 */
        }
        .detail-card p, .detail-card ul, .detail-card div {
            color: #4b5563; /* gray-700 */
            font-size: 0.9rem;
        }
        .detail-card ul li {
            margin-bottom: 0.25rem;
        }
        .timeline-item {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .timeline-item-header {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        .timeline-item-body {
            color: #4b5563;
        }
        .timeline-date {
            font-size: 0.8em;
            color: #6b7280;
            margin-bottom: 0.25em;
        }
        /* Calendar specific styles (General for all calendars) */
        .calendar-grid-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background-color: #e2e8f0; /* blue-gray-200 */
            border: 1px solid #cbd5e1; /* blue-gray-300 */
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .calendar-header-day {
            background-color: #cbd5e1; /* blue-gray-300 */
            font-weight: 600;
            padding: 0.5rem;
            text-align: center;
            color: #2d3748; /* gray-800 */
        }
        .calendar-day {
            background-color: #ffffff;
            min-height: 120px; /* Adjust as needed */
            padding: 0.5rem;
            border: 1px solid #e2e8f0; /* blue-gray-200 */
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
        }
        .calendar-day-number {
            font-weight: 700;
            font-size: 1.1em;
            color: #1a202c; /* gray-900 */
            margin-bottom: 0.5rem;
        }
        .calendar-day.empty {
            background-color: #f8fafc; /* gray-50 */
            color: #cbd5e1; /* blue-gray-300 */
        }
        .operation-event, .appointment-event {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.25rem;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: pointer;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .operation-event {
            background-color: #a7f3d0; /* green-200 */
            color: #065f46; /* green-800 */
        }
        .operation-event:hover {
            background-color: #6ee7b7; /* green-300 */
        }
        .operation-event.past {
            background-color: #e2e8f0; /* blue-gray-200 */
            color: #64748b; /* blue-gray-600 */
        }
        .operation-event.cancelled {
            background-color: #fecaca; /* red-200 */
            color: #991b1b; /* red-800 */
            text-decoration: line-through;
        }
        .operation-event.current-day {
            border: 2px solid #3b82f6; /* blue-500 */
        }

        /* Specific styles for Appointment events */
        .appointment-event {
            background-color: #bfdbfe; /* blue-200 */
            color: #1e40af; /* blue-800 */
        }
        .appointment-event:hover {
            background-color: #93c5fd; /* blue-300 */
        }
        .appointment-event.cancelled {
            background-color: #fecaca; /* red-200 */
            color: #991b1b; /* red-800 */
            text-decoration: line-through;
        }
        .appointment-event.completed { /* New status for appointments */
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }
        .appointment-event.rescheduled { /* New status for appointments */
            background-color: #fef3c7; /* yellow-100 */
            color: #92400e; /* yellow-800 */
            font-style: italic;
        }
        .appointment-event.current-day {
            border: 2px solid #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="flex h-screen bg-gray-100">

    <!-- Écran de connexion -->
    <div id="login-screen" class="flex items-center justify-center h-full w-full">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h2 class="text-3xl font-bold text-center text-blue-800 mb-8">Connexion au SGHO</h2>
            <div id="login-message-container" class="mb-4"></div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Nom d'utilisateur</label>
                    <input type="text" id="username" name="username" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Mot de passe</label>
                    <input type="password" id="password" name="password" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md shadow-lg transition-colors duration-200">
                    Se connecter
                </button>
            </form>
            <div class="mt-6 text-center text-sm text-gray-500">
                <p>Identifiants de test :</p>
                <ul class="list-disc list-inside mt-2 inline-block text-left">
                    <li>Administrateur: `admin` / `pass123`</li>
                    <li>Secrétaire: `secretaire` / `pass123`</li>
                    <li>Médecin: `medecin` / `pass123`</li>
                    <li>Agent Labo: `labo` / `pass123`</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Contenu principal de l'application (masqué par défaut) -->
    <div id="app-content" class="flex-1 flex">
        <!-- Barre latérale de navigation -->
        <aside class="w-64 bg-blue-800 text-white flex flex-col p-4 rounded-r-xl shadow-lg">
            <div class="text-2xl font-bold mb-8 text-center py-4">
                <span class="block">Hôpital</span>
                <span class="block">Exemple</span>
                <span id="user-info" class="block text-sm font-normal mt-2"></span>
            </div>
            <nav class="flex-1">
                <ul>
                    <li class="mb-2" data-roles="admin">
                        <button class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" data-module="user-management">
                            Gestion des Utilisateurs
                        </button>
                    </li>
                    <li class="mb-2" data-roles="secretaire,medecin">
                        <button class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" data-module="patients">
                            Gestion des Patients
                        </button>
                    </li>
                     <li class="mb-2" data-roles="secretaire">
                        <button class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" data-module="emergency-queue">
                            File d'attente Urgences
                        </button>
                    </li>
                    <li class="mb-2" data-roles="medecin,secretaire">
                        <button class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" data-module="emr">
                            Dossiers Médicaux Électroniques (DME)
                        </button>
                    </li>
                    <li class="mb-2" data-roles="secretaire,medecin">
                        <button class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" data-module="admissions-beds">
                            Gestion des Admissions & Lits
                        </button>
                    </li>
                    <li class="mb-2" data-roles="secretaire,medecin">
                        <button class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" data-module="appointments">
                            Planification des Rendez-vous
                        </button>
                    </li>
                    <li class="mb-2" data-roles="secretaire">
                        <button class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" data-module="disponibilites">
                            Disponibilités Médecins
                        </button>
                    </li>
                    <li class="mb-2" data-roles="medecin">
                        <button class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" data-module="prescription">
                            Module de Prescription
                        </button>
                    </li>
                    <li class="mb-2" data-roles="lab_agent,medecin">
                        <button class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" data-module="labs">
                            Gestion des Laboratoires
                        </button>
                    </li>
                    <li class="mb-2" data-roles="secretaire,medecin">
                        <button class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" data-module="operating-room">
                            Bloc Opératoire
                        </button>
                    </li>
                    <li class="mb-2" data-roles="secretaire">
                        <button class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" data-module="billing">
                            Facturation & Comptabilité
                        </button>
                    </li>
                    <li class="mb-2" data-roles="secretaire,lab_agent">
                        <button class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" data-module="inventory">
                            Stocks & Achats
                        </button>
                    </li>
                    <li class="mb-2" data-roles="secretaire,medecin">
                        <button class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" data-module="medecins">
                            Gestion des Médecins
                        </button>
                    </li>
                </ul>
            </nav>
            <div class="mt-auto pt-4">
                <button id="logout-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-md shadow-lg transition-colors duration-200">
                    Déconnexion
                </button>
            </div>
        </aside>

        <!-- Contenu principal -->
        <main class="flex-1 flex flex-col p-8 overflow-y-auto">
            <header class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h1 id="main-title" class="text-3xl font-semibold text-gray-800">Tableau de Bord du SGHO</h1>
            </header>

            <!-- Zone d'affichage des messages (succès/erreur) -->
            <div id="message-container" class="mb-4"></div>

            <!-- Section Gestion des Utilisateurs -->
            <section id="user-management" class="module-section bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold text-blue-700 mb-6">Gestion des Comptes Utilisateurs</h2>

                <!-- Ajouter un nouvel utilisateur -->
                <div class="mb-8" data-roles-visibility="admin">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Ajouter un Nouvel Utilisateur</h3>
                    <form id="add-user-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="user_username" class="block text-sm font-medium text-gray-700">Nom d'utilisateur</label>
                            <input type="text" id="user_username" name="username" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="col-span-1">
                            <label for="user_password" class="block text-sm font-medium text-gray-700">Mot de passe</label>
                            <input type="password" id="user_password" name="password" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="col-span-2">
                            <label for="user_role" class="block text-sm font-medium text-gray-700">Rôle</label>
                            <select id="user_role" name="role" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Sélectionner un rôle</option>
                                <option value="admin">Administrateur</option>
                                <option value="secretaire">Secrétaire</option>
                                <option value="medecin">Médecin</option>
                                <option value="lab_agent">Agent Laboratoire</option>
                            </select>
                        </div>
                        <div class="col-span-2 text-right">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                                Créer Utilisateur
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Liste des utilisateurs -->
                <div class="mb-8">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Liste des Utilisateurs Existants</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gray-100 border-b">
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom d'utilisateur</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rôle</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-roles-visibility="admin">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-list">
                                <tr>
                                    <td colspan="4" class="text-center py-4 text-gray-500">Chargement des utilisateurs...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button onclick="loadUsers()" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                        Actualiser la liste
                    </button>
                </div>
            </section>

            <!-- Section Gestion des Patients -->
            <section id="patients" class="module-section bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold text-blue-700 mb-6">Gestion des Patients</h2>

                <!-- Sous-section Admission/Enregistrement (visible par secrétaire) -->
                <div class="mb-8" data-roles-visibility="secretaire">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Admission / Enregistrement d'un Nouveau Patient</h3>
                    <form id="add-patient-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="patient_nom" class="block text-sm font-medium text-gray-700">Nom</label>
                            <input type="text" id="patient_nom" name="nom" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nom du patient" required>
                        </div>
                        <div class="col-span-1">
                            <label for="patient_prenom" class="block text-sm font-medium text-gray-700">Prénom</label>
                            <input type="text" id="patient_prenom" name="prenom" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Prénom du patient" required>
                        </div>
                        <div class="col-span-1">
                            <label for="patient_dob" class="block text-sm font-medium text-gray-700">Date de Naissance</label>
                            <input type="date" id="patient_dob" name="date_naissance" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="col-span-1">
                            <label for="patient_genre" class="block text-sm font-medium text-gray-700">Genre</label>
                            <select id="patient_genre" name="genre" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Sélectionner</option>
                                <option value="homme">Homme</option>
                                <option value="femme">Femme</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label for="patient_adresse" class="block text-sm font-medium text-gray-700">Adresse</label>
                            <textarea id="patient_adresse" name="adresse" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Adresse complète" required></textarea>
                        </div>
                        <div class="col-span-1">
                            <label for="patient_telephone" class="block text-sm font-medium text-gray-700">Téléphone</label>
                            <input type="text" id="patient_telephone" name="telephone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0612345678" required>
                        </div>
                        <div class="col-span-1">
                            <label for="patient_email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="patient_email" name="email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="email@example.com">
                        </div>
                        <div class="col-span-2">
                            <label for="patient_allergies" class="block text-sm font-medium text-gray-700">Allergies connues</label>
                            <textarea id="patient_allergies" name="allergies" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Pénicilline, arachides..."></textarea>
                        </div>
                        <div class="col-span-2">
                            <label for="patient_antecedents" class="block text-sm font-medium text-gray-700">Antécédents Médicaux (bref)</label>
                            <textarea id="patient_antecedents" name="antecedents_chirurgicaux" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Appendicectomie (2010), Diabète type 2..."></textarea>
                        </div>
                        <div class="col-span-2">
                            <label for="patient_assurance" class="block text-sm font-medium text-gray-700">Info Assurance</label>
                            <input type="text" id="patient_assurance" name="info_assurance" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Compagnie, numéro de police">
                        </div>
                        <div class="col-span-2 text-right">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                                Enregistrer Patient
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Sous-section Liste des Patients -->
                <div class="mb-8">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Liste des Patients Enregistrés</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gray-100 border-b">
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom Prénom</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Naissance</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Téléphone</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-roles-visibility="secretaire">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="patients-list">
                                <!-- Les patients seront chargés ici dynamiquement par JavaScript -->
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-gray-500">Chargement des patients...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button onclick="loadPatients()" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                        Actualiser la liste
                    </button>
                </div>
            </section>

            <!-- Section File d'attente Urgences -->
            <section id="emergency-queue" class="module-section bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold text-blue-700 mb-6">File d'attente des Urgences</h2>

                <!-- Ajouter à la file (pour la secrétaire) -->
                <div class="mb-8" data-roles-visibility="secretaire">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Ajouter un patient à la file d'attente</h3>
                    <form id="add-to-emergency-queue-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="queue_patient_id" class="block text-sm font-medium text-gray-700">ID Patient</label>
                            <input type="number" id="queue_patient_id" name="patient_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ID du patient" required>
                        </div>
                        <div class="col-span-2">
                            <label for="queue_notes" class="block text-sm font-medium text-gray-700">Notes (Optionnel)</label>
                            <textarea id="queue_notes" name="notes" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Motifs d'admission, état initial..."></textarea>
                        </div>
                        <div class="col-span-2 text-right">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                                Ajouter à la file
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Liste de la file d'attente -->
                <div class="mb-8">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Patients en attente</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gray-100 border-b">
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID File</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient (ID)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Heure d'entrée</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="emergency-queue-list">
                                <!-- Les patients en attente seront chargés ici -->
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-gray-500">Chargement de la file d'attente...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button onclick="loadEmergencyQueue()" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                        Actualiser la file
                    </button>
                </div>
            </section>

            <!-- Section Dossiers Médicaux Électroniques (DME) -->
            <section id="emr" class="module-section bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold text-blue-700 mb-6">Dossiers Médicaux Électroniques (DME)</h2>

                <!-- Recherche de patient et affichage consolidé (visible par médecin) -->
                <div class="mb-8" data-roles-visibility="medecin">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Rechercher un Patient pour consulter son DME</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="md:col-span-2">
                            <label for="emr_search_patient" class="sr-only">Rechercher par Nom, Prénom ou ID Patient</label>
                            <input type="text" id="emr_search_patient" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Rechercher par Nom, Prénom ou ID Patient">
                        </div>
                        <div class="md:col-span-1">
                            <button id="emr_search_button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                                Rechercher Patient
                            </button>
                        </div>
                    </div>
                    <div id="emr-search-results" class="mb-4">
                        <!-- Les résultats de recherche rapide s'afficheront ici -->
                    </div>

                    <div id="patient-consolidated-view" class="hidden">
                        <h3 class="text-xl font-medium text-gray-700 mb-4">Dossier de <span id="current-patient-name" class="font-bold"></span> (ID: <span id="current-patient-id" class="font-bold"></span>)</h3>

                        <!-- Détails du Patient -->
                        <div class="detail-card">
                            <h4>Informations Générales du Patient</h4>
                            <p><strong>Date de Naissance:</strong> <span id="patient-dob-display"></span></p>
                            <p><strong>Genre:</strong> <span id="patient-genre-display"></span></p>
                            <p><strong>Téléphone:</strong> <span id="patient-phone-display"></span></p>
                            <p><strong>Email:</strong> <span id="patient-email-display"></span></p>
                            <p><strong>Adresse:</strong> <span id="patient-address-display"></span></p>
                            <p><strong>Allergies:</strong> <span id="patient-allergies-display"></span></p>
                            <p><strong>Antécédents:</strong> <span id="patient-antecedents-display"></span></p>
                            <p><strong>Info Assurance:</strong> <span id="patient-insurance-display"></span></p>
                        </div>

                        <!-- Historique Chronologique -->
                        <div class="detail-card">
                            <h4>Historique Chronologique du Patient</h4>
                            <div id="patient-timeline-view" class="space-y-3">
                                <p class="text-center text-gray-500">Chargement de l'historique...</p>
                            </div>
                        </div>

                        <!-- Diagnostics du Patient -->
                        <div class="detail-card">
                            <h4>Diagnostics</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                                    <thead>
                                        <tr class="bg-gray-100 border-b">
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code CIM</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gravité</th>
                                        </tr>
                                    </thead>
                                    <tbody id="patient-diagnoses-list">
                                        <tr><td colspan="5" class="text-center py-2 text-gray-500">Aucun diagnostic trouvé.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Observations du Patient -->
                        <div class="detail-card">
                            <h4>Observations Cliniques</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                                    <thead>
                                        <tr class="bg-gray-100 border-b">
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Heure</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valeur</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="patient-observations-list">
                                        <tr><td colspan="5" class="text-center py-2 text-gray-500">Aucune observation trouvée.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Prescriptions du Patient -->
                        <div class="detail-card">
                            <h4>Prescriptions</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                                    <thead>
                                        <tr class="bg-gray-100 border-b">
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Médicament</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantité</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Instructions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="patient-prescriptions-list">
                                        <tr><td colspan="5" class="text-center py-2 text-gray-500">Aucune prescription trouvée.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tests Laboratoire du Patient -->
                        <div class="detail-card">
                            <h4>Tests Laboratoire</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                                    <thead>
                                        <tr class="bg-gray-100 border-b">
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type de Test</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Demande</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Résultat</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Résultats</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                        </tr>
                                    </thead>
                                    <tbody id="patient-lab-tests-list">
                                        <tr><td colspan="6" class="text-center py-2 text-gray-500">Aucun test laboratoire trouvé.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulaires existants pour ajouter Diagnostics/Observations (reste ici pour accès général) -->
                <!-- Ajouter un Diagnostic (visible par médecin) -->
                <div class="mb-8" data-roles-visibility="medecin">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Ajouter un Diagnostic</h3>
                    <form id="add-diagnosis-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="diagnosis_patient_id" class="block text-sm font-medium text-gray-700">ID Patient</label>
                            <input type="number" id="diagnosis_patient_id" name="patient_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ID du patient" required>
                        </div>
                        <div class="col-span-1">
                            <label for="diagnosis_medecin_id" class="block text-sm font-medium text-gray-700">ID Médecin (Optionnel)</label>
                            <input type="number" id="diagnosis_medecin_id" name="medecin_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ID du médecin">
                        </div>
                        <div class="col-span-1">
                            <label for="diagnosis_date" class="block text-sm font-medium text-gray-700">Date du Diagnostic</label>
                            <input type="date" id="diagnosis_date" name="date_diagnostic" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="col-span-1">
                            <label for="diagnosis_code_cim" class="block text-sm font-medium text-gray-700">Code CIM-10 (Optionnel)</label>
                            <input type="text" id="diagnosis_code_cim" name="code_cim" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: I10 (Hypertension)">
                        </div>
                        <div class="col-span-2">
                            <label for="diagnosis_description" class="block text-sm font-medium text-gray-700">Description du Diagnostic</label>
                            <textarea id="diagnosis_description" name="description" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Description détaillée du diagnostic" required></textarea>
                        </div>
                        <div class="col-span-1">
                            <label for="diagnosis_gravite" class="block text-sm font-medium text-gray-700">Gravité (Optionnel)</label>
                            <input type="text" id="diagnosis_gravite" name="gravite" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Légère, Modérée, Sévère">
                        </div>
                        <div class="col-span-2 text-right">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                                Ajouter Diagnostic
                            </button>
                        </div>
                    </form>
                </div>

                <div class="mb-8">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Liste des Diagnostics</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gray-100 border-b">
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient ID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gravité</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-roles-visibility="medecin">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="diagnoses-list">
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-gray-500">Chargement des diagnostics...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button onclick="loadDiagnoses()" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                        Actualiser les diagnostics
                    </button>
                </div>

                <!-- Ajouter une Observation Clinique (visible par médecin) -->
                <div class="mb-8" data-roles-visibility="medecin">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Ajouter une Observation Clinique</h3>
                    <form id="add-observation-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="obs_patient_id" class="block text-sm font-medium text-gray-700">ID Patient</label>
                            <input type="number" id="obs_patient_id" name="patient_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ID du patient" required>
                        </div>
                        <div class="col-span-1">
                            <label for="obs_medecin_id" class="block text-sm font-medium text-gray-700">ID Médecin (Optionnel)</label>
                            <input type="number" id="obs_medecin_id" name="medecin_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ID du médecin">
                        </div>
                        <div class="col-span-1">
                            <label for="obs_date_time" class="block text-sm font-medium text-gray-700">Date & Heure Observation</label>
                            <input type="datetime-local" id="obs_date_time" name="date_observation" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="col-span-1">
                            <label for="obs_type" class="block text-sm font-medium text-gray-700">Type d'Observation</label>
                            <input type="text" id="obs_type" name="type_observation" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Température, Poids, Note infirmière" required>
                        </div>
                        <div class="col-span-1">
                            <label for="obs_value" class="block text-sm font-medium text-gray-700">Valeur</label>
                            <input type="text" id="obs_value" name="valeur" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: 37.5, 70, 'État général stable'" required>
                        </div>
                        <div class="col-span-1">
                            <label for="obs_unit" class="block text-sm font-medium text-gray-700">Unité (Optionnel)</label>
                            <input type="text" id="obs_unit" name="unite" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: °C, kg, mmHg">
                        </div>
                        <div class="col-span-2">
                            <label for="obs_notes" class="block text-sm font-medium text-gray-700">Notes (Optionnel)</label>
                            <textarea id="obs_notes" name="notes" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Détails supplémentaires"></textarea>
                        </div>
                        <div class="col-span-2 text-right">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                                Ajouter Observation
                            </button>
                        </div>
                    </form>
                </div>

                <div>
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Liste des Observations</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gray-100 border-b">
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient ID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Heure</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valeur (Unité)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-roles-visibility="medecin">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="observations-list">
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-gray-500">Chargement des observations...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button onclick="loadObservations()" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                        Actualiser les observations
                    </button>
                </div>
            </section>

            <!-- Section Gestion des Admissions et Lits (Nouveau Module) -->
            <section id="admissions-beds" class="module-section bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold text-blue-700 mb-6">Gestion des Admissions & Lits</h2>

                <!-- Sous-section Admission / Assignation de Lit -->
                <div class="mb-8" data-roles-visibility="secretaire">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Admission / Assignation de Lit</h3>
                    <form id="assign-bed-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="assign_patient_id" class="block text-sm font-medium text-gray-700">ID Patient</label>
                            <input type="number" id="assign_patient_id" name="patient_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ID du patient" required>
                        </div>
                        <div class="col-span-1">
                            <label for="assign_bed_id" class="block text-sm font-medium text-gray-700">Lit Disponible</label>
                            <select id="assign_bed_id" name="bed_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Chargement des lits...</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label for="assign_date_occupation" class="block text-sm font-medium text-gray-700">Date d'Occupation</label>
                            <input type="date" id="assign_date_occupation" name="date_occupation" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="col-span-2 text-right">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                                Assigner Lit
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Sous-section Lits Occupés (pour libérer ou transférer) -->
                <div class="mb-8">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Lits Actuellement Occupés</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gray-100 border-b">
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lit N°</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient (ID)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Occ.</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-roles-visibility="secretaire">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="occupied-beds-list">
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-gray-500">Chargement des lits occupés...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sous-section Lits Disponibles (pour information) -->
                <div class="mb-8">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Lits Disponibles</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gray-100 border-b">
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lit N°</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service</th>
                                </tr>
                            </thead>
                            <tbody id="available-beds-list">
                                <tr>
                                    <td colspan="2" class="text-center py-4 text-gray-500">Chargement des lits disponibles...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                 <button onclick="loadBedsForAdmissions()" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                    Actualiser les Lits
                </button>
            </section>

            <!-- Section Module de Prescription -->
            <section id="prescription" class="module-section bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold text-blue-700 mb-6">Module de Prescription</h2>
                <!-- Ajouter une nouvelle Prescription (visible par médecin) -->
                <div class="mb-8" data-roles-visibility="medecin">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Ajouter une nouvelle Prescription</h3>
                    <form id="add-prescription-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="prescription_patient_id" class="block text-sm font-medium text-gray-700">ID Patient</label>
                            <input type="number" id="prescription_patient_id" name="patient_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ID du patient" required>
                        </div>
                        <div class="col-span-1">
                            <label for="prescription_medecin_id" class="block text-sm font-medium text-gray-700">ID Médecin</label>
                            <input type="number" id="prescription_medecin_id" name="medecin_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ID du médecin" required>
                        </div>
                        <div class="col-span-1">
                            <label for="prescription_medicament_id" class="block text-sm font-medium text-gray-700">ID Médicament (Optionnel)</label>
                            <input type="number" id="prescription_medicament_id" name="medicament_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ID du médicament existant">
                        </div>
                        <div class="col-span-1">
                            <label for="prescription_nom_medicament_texte" class="block text-sm font-medium text-gray-700">Nom Médicament (Texte Libre)</label>
                            <input type="text" id="prescription_nom_medicament_texte" name="nom_medicament_texte" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Si non trouvé par ID">
                        </div>
                        <div class="col-span-1">
                            <label for="prescription_date" class="block text-sm font-medium text-gray-700">Date Prescription</label>
                            <input type="date" id="prescription_date" name="date_prescription" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="col-span-1">
                            <label for="prescription_quantite" class="block text-sm font-medium text-gray-700">Quantité</label>
                            <input type="text" id="prescription_quantite" name="quantite" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: 1 boîte, 20 comprimés">
                        </div>
                        <div class="col-span-2">
                            <label for="prescription_instructions" class="block text-sm font-medium text-gray-700">Instructions</label>
                            <textarea id="prescription_instructions" name="instructions" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Instructions supplémentaires pour le patient..."></textarea>
                        </div>
                        <div class="col-span-2 text-right">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                                Enregistrer Prescription
                            </button>
                        </div>
                    </form>
                </div>
                <!-- Vous pouvez ajouter une liste de prescriptions ici comme pour les patients -->
                <div class="mt-4 bg-gray-50 p-4 rounded-md border border-gray-200">
                    <p class="text-gray-600">
                        Cette section permet d'ajouter des prescriptions. Une liste dynamique des prescriptions peut être ajoutée ici, similaire à la liste des patients.
                    </p>
                </div>
            </section>

            <!-- Section Gestion des Laboratoires -->
            <section id="labs" class="module-section bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold text-blue-700 mb-6">Gestion des Laboratoires</h2>
                <!-- Demander un Test Laboratoire (visible par médecin) -->
                <div class="mb-8" data-roles-visibility="medecin">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Demander un Test Laboratoire</h3>
                    <form id="add-lab-test-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="lab_patient_id" class="block text-sm font-medium text-gray-700">ID Patient</label>
                            <input type="number" id="lab_patient_id" name="patient_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ID du patient" required>
                        </div>
                        <div class="col-span-1">
                            <label for="lab_type_test" class="block text-sm font-medium text-gray-700">Type de Test</label>
                            <input type="text" id="lab_type_test" name="type_test" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Analyse sanguine, IRM" required>
                        </div>
                        <div class="col-span-1">
                            <label for="lab_date_demande" class="block text-sm font-medium text-gray-700">Date Demande</label>
                            <input type="date" id="lab_date_demande" name="date_demande" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="col-span-1">
                            <label for="lab_date_resultat" class="block text-sm font-medium text-gray-700">Date Résultat (Optionnel)</label>
                            <input type="date" id="lab_date_resultat" name="date_resultat" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="col-span-2">
                            <label for="lab_results" class="block text-sm font-medium text-gray-700">Résultats (Texte Libre)</label>
                            <textarea id="lab_results" name="resultats" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Glycémie: 1.20 g/L (élevée)"></textarea>
                        </div>
                        <div class="col-span-2">
                            <label for="lab_notes" class="block text-sm font-medium text-gray-700">Notes (Optionnel)</label>
                            <textarea id="lab_notes" name="notes" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Instructions supplémentaires ou interprétation..."></textarea>
                        </div>
                        <div class="col-span-1">
                            <label for="lab_status" class="block text-sm font-medium text-gray-700">Statut</label>
                            <select id="lab_status" name="statut" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="En attente">En attente</option>
                                <option value="En cours">En cours</option>
                                <option value="Complété">Complété</option>
                                <option value="Annulé">Annulé</option>
                            </select>
                        </div>
                        <div class="col-span-2 text-right">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                                Demander Test Labo
                            </button>
                        </div>
                    </form>
                </div>
                <div class="mt-4 bg-gray-50 p-4 rounded-md border border-gray-200">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Liste des Tests en Cours</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gray-100 border-b">
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Test</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient ID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Demande</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-roles-visibility="lab_agent">Résultats & Actions</th>
                                </tr>
                            </thead>
                            <tbody id="lab-tests-list">
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-gray-500">Chargement des tests...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button onclick="loadLabTests()" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                        Actualiser la liste
                    </button>
                </div>
            </section>

            <!-- Section Bloc Opératoire -->
            <section id="operating-room" class="module-section bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold text-blue-700 mb-6">Planification du Bloc Opératoire</h2>

                <!-- Calendrier des Opérations -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                            Mois Précédent
                        </button>
                        <h3 id="current-month-year" class="text-xl font-medium text-gray-700"></h3>
                        <button id="next-month-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                            Mois Suivant
                        </button>
                    </div>
                    <div id="calendar-container" class="calendar-grid-container">
                        <!-- Les jours de la semaine (en-têtes) -->
                        <div class="calendar-header-day">Lun</div>
                        <div class="calendar-header-day">Mar</div>
                        <div class="calendar-header-day">Mer</div>
                        <div class="calendar-header-day">Jeu</div>
                        <div class="calendar-header-day">Ven</div>
                        <div class="calendar-header-day">Sam</div>
                        <div class="calendar-header-day">Dim</div>
                        <!-- Les jours du mois seront générés ici par JS -->
                    </div>
                </div>

                <h3 class="text-xl font-medium text-gray-700 mb-4">Planifier une nouvelle Opération</h3>
                <form id="add-operation-form" class="grid grid-cols-1 md:grid-cols-2 gap-4" data-roles-visibility="secretaire,medecin">
                    <div class="col-span-1">
                        <label for="op_patient_id" class="block text-sm font-medium text-gray-700">ID Patient</label>
                        <input type="number" id="op_patient_id" name="patient_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ID du patient" required>
                    </div>
                    <div class="col-span-1">
                        <label for="op_medecin_id" class="block text-sm font-medium text-gray-700">ID Médecin (Chirurgien Principal)</label>
                        <input type="number" id="op_medecin_id" name="medecin_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ID du médecin" required>
                    </div>
                    <div class="col-span-2">
                        <label for="op_procedure_name" class="block text-sm font-medium text-gray-700">Description de la Procédure</label>
                        <input type="text" id="op_procedure_name" name="procedure_name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Appendicectomie, pose de stent" required>
                    </div>
                    <div class="col-span-1">
                        <label for="op_date" class="block text-sm font-medium text-gray-700">Date Opération</label>
                        <input type="date" id="op_date" name="date_operation" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="col-span-1">
                        <label for="op_heure_debut" class="block text-sm font-medium text-gray-700">Heure Début</label>
                        <input type="time" id="op_heure_debut" name="heure_debut" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                     <div class="col-span-1">
                        <label for="op_heure_fin" class="block text-sm font-medium text-gray-700">Heure Fin (Optionnel)</label>
                        <input type="time" id="op_heure_fin" name="heure_fin" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="op_salle_operation" class="block text-sm font-medium text-gray-700">Salle d'Opération</label>
                        <input type="text" id="op_salle_operation" name="salle_operation" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Salle 1, Bloc A">
                    </div>
                    <div class="col-span-2">
                        <label for="op_personnel_notes" class="block text-sm font-medium text-gray-700">Personnel / Équipement / Notes</label>
                        <textarea id="op_personnel_notes" name="personnel_notes" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Chirurgien, anesthésiste, personnel infirmier, équipements spécifiques..."></textarea>
                    </div>
                    <div class="col-span-1">
                        <label for="op_status" class="block text-sm font-medium text-gray-700">Statut</label>
                        <select id="op_status" name="statut" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="Planifiée">Planifiée</option>
                            <option value="En cours">En cours</option>
                            <option value="Terminée">Terminée</option>
                            <option value="Annulée">Annulée</option>
                        </select>
                    </div>
                    <div class="col-span-2 text-right">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                            Planifier Opération
                        </button>
                    </div>
                </form>
            </section>

            <!-- Section Planification des Rendez-vous -->
            <section id="appointments" class="module-section bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold text-blue-700 mb-6">Planification des Rendez-vous</h2>

                <!-- Calendrier des Rendez-vous -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <button id="appt-prev-month-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                            Mois Précédent
                        </button>
                        <h3 id="current-appt-month-year" class="text-xl font-medium text-gray-700"></h3>
                        <button id="appt-next-month-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                            Mois Suivant
                        </button>
                    </div>
                    <div id="appointments-calendar-container" class="calendar-grid-container">
                        <!-- Les jours de la semaine (en-têtes) -->
                        <div class="calendar-header-day">Lun</div>
                        <div class="calendar-header-day">Mar</div>
                        <div class="calendar-header-day">Mer</div>
                        <div class="calendar-header-day">Jeu</div>
                        <div class="calendar-header-day">Ven</div>
                        <div class="calendar-header-day">Sam</div>
                        <div class="calendar-header-day">Dim</div>
                        <!-- Les jours du mois seront générés ici par JS -->
                    </div>
                </div>

                <!-- Ajouter un nouveau Rendez-vous (visible par secrétaire) -->
                <div class="mb-8" data-roles-visibility="secretaire">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Ajouter un nouveau Rendez-vous</h3>
                    <form id="add-appointment-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="appt_patient_id" class="block text-sm font-medium text-gray-700">ID Patient</label>
                            <input type="number" id="appt_patient_id" name="patient_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ID du patient" required>
                        </div>
                        <div class="col-span-1">
                            <label for="appt_medecin_id" class="block text-sm font-medium text-gray-700">Médecin</label>
                            <select id="appt_medecin_id" name="medecin_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Sélectionner un médecin (Optionnel)</option>
                                <!-- Les médecins seront chargés ici dynamiquement par JavaScript -->
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label for="appt_date_heure_date" class="block text-sm font-medium text-gray-700">Date du Rendez-vous</label>
                            <input type="date" id="appt_date_heure_date" name="date_heure_date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="col-span-1">
                            <label for="appt_date_heure_time" class="block text-sm font-medium text-gray-700">Heure du Rendez-vous</label>
                            <input type="time" id="appt_date_heure_time" name="date_heure_time" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="col-span-2">
                            <label for="appt_raison" class="block text-sm font-medium text-gray-700">Raison du Rendez-vous</label>
                            <textarea id="appt_raison" name="raison" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Consultation de suivi, urgence, examen..." required></textarea>
                        </div>
                        <div class="col-span-2 text-right">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                                Planifier Rendez-vous
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Sous-section Liste des Rendez-vous -->
                <div class="mb-8">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Liste des Rendez-vous Planifiés</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gray-100 border-b">
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID RDV</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient ID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Médecin ID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Heure</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Raison</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-roles-visibility="secretaire">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="appointments-list">
                                <!-- Les rendez-vous seront chargés ici dynamiquement par JavaScript -->
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-gray-500">Chargement des rendez-vous...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button onclick="loadAppointments()" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                        Actualiser la liste
                    </button>
                </div>
            </section>

            <!-- Section Gestion des Disponibilités des Médecins (Nouveau Module) -->
            <section id="disponibilites" class="module-section bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold text-blue-700 mb-6">Gestion des Disponibilités des Médecins</h2>

                <!-- Ajouter une nouvelle Disponibilité (visible par secrétaire) -->
                <div class="mb-8" data-roles-visibility="secretaire">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Ajouter une nouvelle Disponibilité</h3>
                    <form id="add-availability-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="availability_medecin_id" class="block text-sm font-medium text-gray-700">Médecin</label>
                            <select id="availability_medecin_id" name="medecin_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Sélectionner un médecin</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label for="availability_date" class="block text-sm font-medium text-gray-700">Date de Disponibilité</label>
                            <input type="date" id="availability_date" name="date_disponibilite" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="col-span-1">
                            <label for="availability_heure_debut" class="block text-sm font-medium text-gray-700">Heure Début</label>
                            <input type="time" id="availability_heure_debut" name="heure_debut" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="col-span-1">
                            <label for="availability_heure_fin" class="block text-sm font-medium text-gray-700">Heure Fin</label>
                            <input type="time" id="availability_heure_fin" name="heure_fin" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="col-span-1">
                            <label for="availability_statut" class="block text-sm font-medium text-gray-700">Statut</label>
                            <select id="availability_statut" name="statut" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="Disponible">Disponible</option>
                                <option value="Occupé">Occupé</option>
                                <option value="Annulé">Annulé</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label for="availability_notes" class="block text-sm font-medium text-gray-700">Notes (Optionnel)</label>
                            <textarea id="availability_notes" name="notes" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Raison de l'indisponibilité, commentaires..."></textarea>
                        </div>
                        <div class="col-span-2 text-right">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                                Ajouter Disponibilité
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Liste des Disponibilités -->
                <div class="mt-6">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Disponibilités des Médecins</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gray-100 border-b">
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Disp.</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Médecin (ID)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Heure Début</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Heure Fin</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-roles-visibility="secretaire">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="availabilities-list">
                                <!-- Les disponibilités seront chargées ici dynamiquement par JavaScript -->
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-gray-500">Chargement des disponibilités...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button onclick="loadAvailabilities()" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md transition-colors duration-200">
                        Actualiser la liste
                    </button>
                </div>
            </section>
        </main>
    </div>

    <script>
        // JavaScript pour la navigation entre les modules et l'interaction avec le backend

        // --- Configuration de l'API Backend ---
        // TRÈS IMPORTANT : Mettez à jour cette URL pour qu'elle corresponde à votre configuration WAMP.
        // Si votre api.php est dans C:\wamp64\www\gh\, utilisez 'http://localhost/gh/api.php'
        const API_BASE_URL = 'http://localhost/gh/api.php';

        const loginScreen = document.getElementById('login-screen');
        const appContent = document.getElementById('app-content');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const loginMessageContainer = document.getElementById('login-message-container');
        const messageContainer = document.getElementById('message-container');
        const userInfoDisplay = document.getElementById('user-info');

        // Stockage du rôle de l'utilisateur connecté
        let currentUser = { loggedIn: false, role: null, username: null };

        // Calendar state for Operating Room (Bloc Opératoire)
        let currentOperationCalendarDate = new Date(); // Stores the currently displayed month/year

        // Calendar state for Appointments (Rendez-vous)
        let currentAppointmentCalendarDate = new Date(); // Stores the currently displayed month/year for appointments

        // Function to display success or error messages to the user
        function displayMessage(container, message, type) {
            container.innerHTML = `<div class="message-box ${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Function to update element visibility based on user role
        function updateUIBasedOnRole() {
            const allRoleElements = document.querySelectorAll('[data-roles-visibility]');
            allRoleElements.forEach(element => {
                const requiredRoles = element.dataset.rolesVisibility.split(',').map(r => r.trim());
                if (currentUser.loggedIn && requiredRoles.includes(currentUser.role)) {
                    element.style.display = element.tagName === 'FORM' || element.tagName === 'DIV' || element.tagName === 'BUTTON' ? 'block' : ''; // Default to block or empty for inline elements
                    // Special case for table headers (th) - they should use their default display type
                    if (element.tagName === 'TH') {
                        element.style.display = '';
                    }
                } else {
                    element.style.display = 'none';
                }
            });

            // Handle navigation item visibility
            const navItems = document.querySelectorAll('aside nav ul li');
            navItems.forEach(item => {
                const requiredRoles = item.dataset.roles ? item.dataset.roles.split(',').map(r => r.trim()) : [];
                if (currentUser.loggedIn && (requiredRoles.length === 0 || requiredRoles.includes(currentUser.role))) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });

            if (currentUser.loggedIn) {
                userInfoDisplay.textContent = `Connecté en tant que: ${currentUser.username} (${currentUser.role})`;
            } else {
                userInfoDisplay.textContent = '';
            }
        }

        // Function to manage app state (logged in/out)
        function setAppStatus(loggedIn, user = null) {
            currentUser.loggedIn = loggedIn;
            currentUser.role = user ? user.role : null;
            currentUser.username = user ? user.username : null;
            currentUser.user_id = user ? user.user_id : null; // Store user_id for self-update checks

            if (loggedIn) {
                loginScreen.style.display = 'none';
                appContent.style.display = 'flex'; // Show app content
                appContent.classList.add('logged-in');
                updateUIBasedOnRole();
                // Show the first authorized module by default
                const firstAllowedModuleButton = document.querySelector(`aside nav ul li[data-roles*="${currentUser.role}"] .nav-item`);
                if (firstAllowedModuleButton) {
                    showModule(firstAllowedModuleButton.dataset.module);
                } else {
                    // If no module is authorized, display a message or an empty dashboard
                    document.querySelectorAll('.module-section').forEach(section => section.classList.remove('active'));
                    document.getElementById('main-title').textContent = "Accès refusé ou aucun module disponible.";
                }
            } else {
                loginScreen.style.display = 'flex';
                appContent.style.display = 'none'; // Hide app content
                appContent.classList.remove('logged-in');
                document.querySelectorAll('.module-section').forEach(section => section.classList.remove('active'));
            }
        }

        // Check login status on page load
        async function checkLoginStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/status`, { method: 'POST' }); // Always POST for status, it's an API choice
                const result = await response.json();
                if (response.ok && result.loggedIn) {
                    setAppStatus(true, result.user);
                } else {
                    setAppStatus(false);
                }
            } catch (error) {
                console.error('Error checking login status:', error);
                displayMessage(loginMessageContainer, 'Error connecting to backend server. Check that WAMP and the .htaccess file are configured.', 'error');
                setAppStatus(false);
            }
        }

        // --- Login and Logout Management ---
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(loginMessageContainer, result.message || 'Login successful!', 'success');
                    setAppStatus(true, result.user);
                } else {
                    displayMessage(loginMessageContainer, result.error || 'Login error.', 'error');
                }
            } catch (error) {
                console.error('Network error during login:', error);
                displayMessage(loginMessageContainer, 'Could not connect to backend server. Check that WAMP is running and the .htaccess file is configured.', 'error');
            }
        });

        logoutButton.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to log out?')) {
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/auth/logout`, { method: 'POST' }); // Always POST for logout
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Logout successful.', 'success');
                    setAppStatus(false);
                } else {
                    displayMessage(messageContainer, result.error || 'Error during logout.', 'error');
                }
            } catch (error) {
                console.error('Network error during logout:', error);
                displayMessage(messageContainer, 'Could not connect to backend server during logout.', 'error');
            }
        });

        // --- Module Navigation Functions ---
        document.addEventListener('DOMContentLoaded', () => {
            const navItems = document.querySelectorAll('.nav-item');
            const moduleSections = document.querySelectorAll('.module-section');
            const mainTitle = document.getElementById('main-title');

            // Function to show the selected module
            window.showModule = (moduleId) => { // Make global for onclick buttons
                // Hide all module sections
                messageContainer.innerHTML = ''; // Clear previous messages
                moduleSections.forEach(section => {
                    section.classList.remove('active');
                });

                // Display the module section corresponding to the ID
                const activeModule = document.getElementById(moduleId);
                if (activeModule) {
                    activeModule.classList.add('active');
                    // Update the main title based on the module
                    const buttonText = document.querySelector(`.nav-item[data-module="${moduleId}"]`).textContent;
                    mainTitle.textContent = buttonText;
                    // Load appropriate data when the module is displayed
                    if (moduleId === 'patients') {
                        loadPatients();
                    } else if (moduleId === 'appointments') {
                        loadAppointments();
                        loadDoctorsForDropdown(); // Populate doctor dropdown for appointments
                        renderAppointmentsCalendar(currentAppointmentCalendarDate.getFullYear(), currentAppointmentCalendarDate.getMonth()); // Render appointments calendar
                    } else if (moduleId === 'medecins') {
                        loadDoctors();
                    } else if (moduleId === 'admissions-beds') { // New module
                        loadBedsForAdmissions(); // Load beds for admission/transfer forms
                    } else if (moduleId === 'inventory') {
                        loadInventory();
                    } else if (moduleId === 'emr') {
                        // When EMR module is activated, we don't load anything by default,
                        // the user must search for a patient.
                        // Ensure consolidated view is hidden initially.
                        document.getElementById('patient-consolidated-view').classList.add('hidden');
                        document.getElementById('emr-search-results').innerHTML = ''; // Clear previous search results
                        document.getElementById('emr_search_patient').value = ''; // Clear search input
                        loadDiagnoses(); // Load all diagnoses for the general list (if still needed)
                        loadObservations(); // Load all observations for the general list (if still needed)
                    } else if (moduleId === 'labs') {
                        loadLabTests(); // Load lab tests when the module is active
                    } else if (moduleId === 'emergency-queue') { // New module
                        loadEmergencyQueue();
                    } else if (moduleId === 'operating-room') { // New module
                        renderOperationCalendar(currentOperationCalendarDate.getFullYear(), currentOperationCalendarDate.getMonth()); // Render calendar for current month
                        loadDoctorsForOperationDropdown(); // Load doctors for OR form
                    } else if (moduleId === 'disponibilites') { // New module
                        loadAvailabilities();
                        loadDoctorsForAvailabilityDropdown(); // Load doctors for availability form
                    } else if (moduleId === 'user-management') { // NEW: User Management module
                        loadUsers();
                    }
                }
            };

            // Add event listeners to navigation buttons
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const moduleId = item.dataset.module;
                    showModule(moduleId);
                });
            });

            checkLoginStatus(); // Check login status on load
        });


        // --- API Interaction Functions (Patients) ---
        document.getElementById('add-patient-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const patientData = {
                nom: form.nom.value, prenom: form.prenom.value, date_naissance: form.date_naissance.value,
                genre: form.genre.value, adresse: form.adresse.value, telephone: form.telephone.value,
                email: form.email.value, allergies: form.allergies.value,
                antecedents_chirurgicaux: form.antecedents_chirurgicaux.value,
                maladies_chroniques: form.maladies_chroniques ? form.maladies_chroniques.value : null,
                info_assurance: form.info_assurance.value
            };
            try {
                const response = await fetch(`${API_BASE_URL}/patients`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(patientData), });
                const result = await response.json();
                if (response.ok) { displayMessage(messageContainer, result.message || 'Patient added successfully!', 'success'); form.reset(); loadPatients(); }
                else { displayMessage(messageContainer, result.error || 'Error adding patient.', 'error'); }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); }
        });

        async function loadPatients() {
            const patientsListBody = document.getElementById('patients-list');
            patientsListBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Loading patients...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/patients`);
                const patients = await response.json();
                if (response.ok) {
                    patientsListBody.innerHTML = '';
                    if (patients.length === 0) { patientsListBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No patients registered.</td></tr>'; return; }
                    patients.forEach(patient => {
                        const row = patientsListBody.insertRow();
                        row.className = 'border-b last:border-b-0';
                        row.innerHTML = `
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${patient.patient_id}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${patient.nom} ${patient.prenom}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${patient.date_naissance}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${patient.telephone}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="deletePatient(${patient.patient_id})" class="text-red-600 hover:text-red-900 ml-2 ${currentUser.role === 'secretaire' ? '' : 'hidden'}">Delete</button>
                            </td>
                        `;
                    });
                } else { displayMessage(messageContainer, patients.error || 'Error loading patients.', 'error'); patientsListBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Loading error.</td></tr>'; }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); patientsListBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Could not connect to server.</td></tr>'; }
        }

        async function deletePatient(patientId) {
            if (!confirm('Are you sure you want to delete this patient?')) { return; }
            try {
                const response = await fetch(`${API_BASE_URL}/patients/${patientId}`, { method: 'DELETE', });
                const result = await response.json();
                if (response.ok) { displayMessage(messageContainer, result.message || 'Patient deleted successfully!', 'success'); loadPatients(); }
                else { displayMessage(messageContainer, result.error || 'Error deleting patient.', 'error'); }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); }
        }


        // --- API Interaction Functions (Appointments) ---
        document.getElementById('add-appointment-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const appointmentData = {
                patient_id: parseInt(form.patient_id.value), medecin_id: form.medecin_id.value === "" ? null : parseInt(form.medecin_id.value),
                date_heure: `${form.date_heure_date.value} ${form.date_heure_time.value}:00`, raison: form.raison.value, statut: 'Planifié'
            };
            try {
                const response = await fetch(`${API_BASE_URL}/appointments`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(appointmentData), });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Appointment added successfully!', 'success');
                    form.reset();
                    loadAppointments(); // Refresh list
                    renderAppointmentsCalendar(currentAppointmentCalendarDate.getFullYear(), currentAppointmentCalendarDate.getMonth()); // Refresh calendar
                }
                else { displayMessage(messageContainer, result.error || 'Error adding appointment.', 'error'); }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); }
        });

        async function loadAppointments() {
            const appointmentsListBody = document.getElementById('appointments-list');
            appointmentsListBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Loading appointments...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/appointments`);
                const appointments = await response.json();
                if (response.ok) {
                    appointmentsListBody.innerHTML = '';
                    if (appointments.length === 0) { appointmentsListBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No appointments registered.</td></tr>'; return; }
                    appointments.forEach(appt => {
                        const row = appointmentsListBody.insertRow();
                        row.className = 'border-b last:border-b-0';
                        row.innerHTML = `
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${appt.rendezvous_id}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${appt.patient_id}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${appt.medecin_id || 'N/A'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${appt.date_heure}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${appt.raison}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                    ${appt.statut === 'Planifié' ? 'bg-blue-100 text-blue-800' :
                                      appt.statut === 'Annulé' ? 'bg-red-100 text-red-800' :
                                      appt.statut === 'Terminé' ? 'bg-green-100 text-green-800' :
                                      appt.statut === 'Reporté' ? 'bg-yellow-100 text-yellow-800' :
                                      'bg-gray-100 text-gray-800'}">
                                    ${appt.statut}
                                </span>
                            </td>
                            <td class="px-4 py-2 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="cancelAppointment(${appt.rendezvous_id})" class="text-red-600 hover:text-red-900 ml-2 ${currentUser.role === 'secretaire' ? '' : 'hidden'}">Cancel</button>
                                <button onclick="rescheduleAppointment(${appt.rendezvous_id})" class="text-blue-600 hover:text-blue-900 ml-2 ${currentUser.role === 'secretaire' ? '' : 'hidden'}">Reschedule</button>
                                <button onclick="completeAppointment(${appt.rendezvous_id})" class="text-green-600 hover:text-green-900 ml-2 ${currentUser.role === 'secretaire' ? '' : 'hidden'}">Complete</button>
                            </td>
                        `;
                    });
                     updateUIBasedOnRole(); // Re-apply role visibility for dynamically added elements
                } else { displayMessage(messageContainer, appointments.error || 'Error loading appointments.', 'error'); appointmentsListBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">Loading error.</td></tr>'; }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); appointmentsListBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">Could not connect to server.</td></tr>'; }
        }

        async function deleteAppointment(appointmentId) {
             if (!confirm('Are you sure you want to delete this appointment?')) { return; }
            try {
                const response = await fetch(`${API_BASE_URL}/appointments/${appointmentId}`, { method: 'DELETE', });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Appointment deleted successfully!', 'success');
                    loadAppointments(); // Refresh list
                    renderAppointmentsCalendar(currentAppointmentCalendarDate.getFullYear(), currentAppointmentCalendarDate.getMonth()); // Refresh calendar
                }
                else { displayMessage(messageContainer, result.error || 'Error deleting appointment.', 'error'); }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); }
        }

        async function cancelAppointment(appointmentId) {
            if (!confirm('Are you sure you want to CANCEL this appointment? This action is irreversible.')) { return; }
            try {
                const response = await fetch(`${API_BASE_URL}/appointments/${appointmentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ statut: 'Annulé' }),
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Appointment cancelled successfully!', 'success');
                    loadAppointments(); // Refresh list
                    renderAppointmentsCalendar(currentAppointmentCalendarDate.getFullYear(), currentAppointmentCalendarDate.getMonth()); // Refresh calendar
                }
                else { displayMessage(messageContainer, result.error || 'Error cancelling appointment.', 'error'); }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); }
        }

        async function rescheduleAppointment(appointmentId) {
            const newDate = prompt('Enter the NEW appointment date (YYYY-MM-DD) :', new Date().toISOString().slice(0,10));
            if (!newDate) {
                displayMessage(messageContainer, 'Reschedule cancelled.', 'info');
                return;
            }
            const newTime = prompt('Enter the NEW appointment time (HH:MM) :', '09:00');
            if (!newTime) {
                displayMessage(messageContainer, 'Reschedule cancelled.', 'info');
                return;
            }
            const newDateTime = `${newDate} ${newTime}:00`;

            try {
                const response = await fetch(`${API_BASE_URL}/appointments/${appointmentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date_heure: newDateTime, statut: 'Reporté' }),
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Appointment rescheduled successfully!', 'success');
                    loadAppointments(); // Refresh list
                    renderAppointmentsCalendar(currentAppointmentCalendarDate.getFullYear(), currentAppointmentCalendarDate.getMonth()); // Refresh calendar
                }
                else { displayMessage(messageContainer, result.error || 'Error rescheduling appointment.', 'error'); }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); }
        }

        async function completeAppointment(appointmentId) {
            if (!confirm('Are you sure you want to mark this appointment as completed?')) { return; }
            try {
                const response = await fetch(`${API_BASE_URL}/appointments/${appointmentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ statut: 'Terminé' }),
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Appointment marked as completed!', 'success');
                    loadAppointments(); // Refresh list
                    renderAppointmentsCalendar(currentAppointmentCalendarDate.getFullYear(), currentAppointmentCalendarDate.getMonth()); // Refresh calendar
                }
                else { displayMessage(messageContainer, result.error || 'Error marking appointment as completed.', 'error'); }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); }
        }


        // --- API Interaction Functions (Doctors) ---
        // Note: The add-medecin-form is not present in the current HTML. This function expects it to be added if needed.
        // document.getElementById('add-medecin-form').addEventListener('submit', async (event) => { /* ... */ });

        async function loadDoctors() {
            const medecinsListBody = document.getElementById('medecins-list');
            if (!medecinsListBody) return; // Prevent error if element doesn't exist
            medecinsListBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Loading doctors...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/medecins`);
                const medecins = await response.json();
                if (response.ok) {
                    medecinsListBody.innerHTML = '';
                    if (medecins.length === 0) { medecinsListBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No doctors registered.</td></tr>'; return; }
                    medecins.forEach(medecin => {
                        const row = medecinsListBody.insertRow();
                        row.className = 'border-b last:border-b-0';
                        row.innerHTML = `
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${medecin.medecin_id}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${medecin.nom} ${medecin.prenom}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${medecin.specialite || 'N/A'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${medecin.telephone || 'N/A'}</td>
                        `;
                    });
                } else { displayMessage(messageContainer, medecins.error || 'Error loading doctors.', 'error'); medecinsListBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Loading error.</td></tr>'; }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); medecinsListBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Could not connect to server.</td></tr>'; }
        }

        async function loadDoctorsForDropdown() {
            const medecinSelect = document.getElementById('appt_medecin_id');
            if (!medecinSelect) return;
            medecinSelect.innerHTML = '<option value="">Select a doctor (Optional)</option>';
            try {
                const response = await fetch(`${API_BASE_URL}/medecins`);
                const doctors = await response.json();
                if (response.ok) { doctors.forEach(doctor => { const option = document.createElement('option'); option.value = doctor.medecin_id; option.textContent = `${doctor.nom} ${doctor.prenom} (${doctor.specialite || 'Not specified'})`; medecinSelect.appendChild(option); }); }
                else { console.error('Error loading doctors for dropdown:', doctors.error); displayMessage(messageContainer, 'Error loading doctors for dropdown.', 'error'); }
            } catch (error) { console.error('Network or server error while loading doctors for dropdown:', error); displayMessage(messageContainer, 'Could not connect to server to load doctors.', 'error'); }
        }

        async function loadDoctorsForOperationDropdown() {
            const medecinSelect = document.getElementById('op_medecin_id');
            if (!medecinSelect) return;
            // Clear existing options except the first one (if any placeholder)
            medecinSelect.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select a doctor';
            medecinSelect.appendChild(defaultOption);

            try {
                const response = await fetch(`${API_BASE_URL}/medecins`);
                const doctors = await response.json();
                if (response.ok) {
                    doctors.forEach(doctor => {
                        const option = document.createElement('option');
                        option.value = doctor.medecin_id;
                        option.textContent = `${doctor.nom} ${doctor.prenom} (${doctor.specialite || 'Not specified'})`;
                        medecinSelect.appendChild(option);
                    });
                } else {
                    console.error('Error loading doctors for OR dropdown:', doctors.error);
                }
            } catch (error) {
                console.error('Network or server error while loading doctors for OR dropdown:', error);
            }
        }

        async function loadDoctorsForAvailabilityDropdown() {
            const medecinSelect = document.getElementById('availability_medecin_id');
            if (!medecinSelect) return;
            medecinSelect.innerHTML = '<option value="">Select a doctor</option>';
            try {
                const response = await fetch(`${API_BASE_URL}/medecins`);
                const doctors = await response.json();
                if (response.ok) { doctors.forEach(doctor => { const option = document.createElement('option'); option.value = doctor.medecin_id; option.textContent = `${doctor.nom} ${doctor.prenom} (${doctor.specialite || 'Not specified'})`; medecinSelect.appendChild(option); }); }
                else { console.error('Error loading doctors for availabilities:', doctors.error); displayMessage(messageContainer, 'Error loading doctors for availabilities.', 'error'); }
            } catch (error) { console.error('Network or server error while loading doctors for availabilities:', error); displayMessage(messageContainer, 'Could not connect to server to load doctors (availabilities).', 'error'); }
        }


        // --- API Interaction Functions (Beds - for Admissions & Beds module) ---
        async function loadBedsForAdmissions() {
            const assignBedSelect = document.getElementById('assign_bed_id');
            const occupiedBedsListBody = document.getElementById('occupied-beds-list');
            const availableBedsListBody = document.getElementById('available-beds-list');

            if (!assignBedSelect || !occupiedBedsListBody || !availableBedsListBody) return; // Prevent error if elements don't exist

            assignBedSelect.innerHTML = '<option value="">Loading beds...</option>';
            occupiedBedsListBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Loading occupied beds...</td></tr>';
            availableBedsListBody.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-gray-500">Loading available beds...</td></tr>';

            try {
                const response = await fetch(`${API_BASE_URL}/lits`);
                const beds = await response.json();

                if (response.ok) {
                    assignBedSelect.innerHTML = '<option value="">Select an available bed</option>';
                    occupiedBedsListBody.innerHTML = '';
                    availableBedsListBody.innerHTML = '';

                    const occupiedBeds = beds.filter(bed => bed.statut === 'Occupé');
                    const availableBeds = beds.filter(bed => bed.statut === 'Disponible');

                    if (availableBeds.length === 0) {
                        assignBedSelect.innerHTML = '<option value="">No available beds</option>';
                        assignBedSelect.disabled = true;
                    } else {
                        assignBedSelect.disabled = false;
                        availableBeds.forEach(bed => {
                            const option = document.createElement('option');
                            option.value = bed.lit_id;
                            option.textContent = `Bed N°${bed.numero_lit} (${bed.service})`;
                            assignBedSelect.appendChild(option);

                            const row = availableBedsListBody.insertRow();
                            row.className = 'border-b last:border-b-0';
                            row.innerHTML = `
                                <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${bed.numero_lit}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${bed.service}</td>
                            `;
                        });
                    }

                    if (occupiedBeds.length === 0) {
                        occupiedBedsListBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No occupied beds.</td></tr>';
                    } else {
                        for (const bed of occupiedBeds) {
                            // Fetch patient details for occupied beds
                            let patientName = 'N/A';
                            if (bed.patient_id) {
                                try {
                                    const patientResponse = await fetch(`${API_BASE_URL}/patients/${bed.patient_id}`);
                                    const patient = await patientResponse.json();
                                    if (patientResponse.ok && patient) {
                                        patientName = `${patient.nom} ${patient.prenom}`;
                                    }
                                } catch (error) {
                                    console.error(`Error loading patient ${bed.patient_id}:`, error);
                                }
                            }

                            const row = occupiedBedsListBody.insertRow();
                            row.className = 'border-b last:border-b-0';
                            row.innerHTML = `
                                <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${bed.numero_lit}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${bed.service}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${patientName} (ID: ${bed.patient_id || 'N/A'})</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${bed.date_occupation || 'N/A'}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-right text-sm font-medium" data-roles-visibility="secretaire">
                                    <button onclick="dischargePatientFromBed(${bed.lit_id})" class="bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded-md shadow-sm transition-colors duration-200">Discharge</button>
                                    <button onclick="promptTransferPatient(${bed.lit_id}, ${bed.patient_id})" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs px-2 py-1 rounded-md shadow-sm transition-colors duration-200 ml-1">Transfer</button>
                                </td>
                            `;
                        }
                    }
                     // Re-apply role visibility for dynamically added elements
                    updateUIBasedOnRole();
                } else {
                    displayMessage(messageContainer, beds.error || 'Error loading beds.', 'error');
                    assignBedSelect.innerHTML = '<option value="">Loading error</option>';
                    occupiedBedsListBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Loading error.</td></tr>';
                    availableBedsListBody.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-red-500">Loading error.</td></tr>';
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
                assignBedSelect.innerHTML = '<option value="">Could not connect</option>';
                occupiedBedsListBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Could not connect to server.</td></tr>';
                availableBedsListBody.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-red-500">Could not connect to server.</td></tr>';
            }
        };

        // Handle form submission for assigning a bed
        document.getElementById('assign-bed-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const patientId = parseInt(form.patient_id.value);
            const bedId = parseInt(form.bed_id.value);
            const dateOccupation = form.date_occupation.value;

            if (isNaN(patientId) || isNaN(bedId) || !dateOccupation) {
                displayMessage(messageContainer, 'Please fill in all required fields.', 'error');
                return;
            }

            // Check if patient exists
            try {
                const patientResponse = await fetch(`${API_BASE_URL}/patients/${patientId}`);
                if (!patientResponse.ok) {
                    displayMessage(messageContainer, 'Patient not found. Please verify patient ID.', 'error');
                    return;
                }
                // Check if bed is available
                const bedResponse = await fetch(`${API_BASE_URL}/lits/${bedId}`);
                const bed = await bedResponse.json();
                if (!bedResponse.ok || bed.statut !== 'Disponible') {
                    displayMessage(messageContainer, 'Bed not available or not found.', 'error');
                    return;
                }
            } catch (error) {
                console.error('Error during patient/bed verification:', error);
                displayMessage(messageContainer, 'Error during data verification. Check your API connection.', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/lits/${bedId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ patient_id: patientId, date_occupation: dateOccupation, statut: 'Occupé' }),
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Bed assigned successfully!', 'success');
                    form.reset();
                    loadBedsForAdmissions(); // Refresh lists
                } else {
                    displayMessage(messageContainer, result.error || 'Error assigning bed.', 'error');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
            }
        });

        // Function to discharge a patient from a bed
        async function dischargePatientFromBed(bedId) {
            if (!confirm('Are you sure you want to free this bed and discharge the patient?')) {
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/lits/${bedId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ patient_id: null, date_occupation: null, statut: 'Disponible' }),
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Bed freed and patient discharged successfully!', 'success');
                    loadBedsForAdmissions(); // Refresh lists
                } else {
                    displayMessage(messageContainer, result.error || 'Error freeing bed.', 'error');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
            }
        }

        // Function to prompt for patient transfer
        async function promptTransferPatient(currentBedId, patientId) {
             const newBedId = prompt(`Transferring patient (ID: ${patientId}) from Bed ID ${currentBedId}.\nPlease enter the ID of the new available bed:`);

            if (newBedId === null || newBedId.trim() === '') {
                displayMessage(messageContainer, 'Transfer cancelled.', 'info');
                return;
            }
            const parsedNewBedId = parseInt(newBedId.trim());
            if (isNaN(parsedNewBedId) || parsedNewBedId === currentBedId) {
                displayMessage(messageContainer, 'Invalid bed ID or same as current bed.', 'error');
                return;
            }

            // Verify new bed is available
            try {
                const newBedResponse = await fetch(`${API_BASE_URL}/lits/${parsedNewBedId}`);
                const newBed = await newBedResponse.json();
                if (!newBedResponse.ok || newBed.statut !== 'Disponible') {
                    displayMessage(messageContainer, 'The new bed is not available or does not exist.', 'error');
                    return;
                }
            } catch (error) {
                console.error('Error during new bed verification:', error);
                displayMessage(messageContainer, 'Error during data verification. Check your API connection.', 'error');
                return;
            }

            // Proceed with transfer
            await transferPatient(currentBedId, parsedNewBedId, patientId);
        }

        async function transferPatient(oldBedId, newBedId, patientId) {
            try {
                // 1. Set old bed to available
                const responseOldBed = await fetch(`${API_BASE_URL}/lits/${oldBedId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ patient_id: null, date_occupation: null, statut: 'Disponible' }),
                });
                const resultOldBed = await responseOldBed.json();
                if (!responseOldBed.ok) {
                    displayMessage(messageContainer, resultOldBed.error || 'Error freeing old bed.', 'error');
                    return;
                }

                // 2. Assign patient to new bed
                const responseNewBed = await fetch(`${API_BASE_URL}/lits/${newBedId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ patient_id: patientId, date_occupation: new Date().toISOString().slice(0, 10), statut: 'Occupé' }),
                });
                const resultNewBed = await responseNewBed.json();
                if (responseNewBed.ok) {
                    displayMessage(messageContainer, resultNewBed.message || 'Patient transferred successfully!', 'success');
                    loadBedsForAdmissions(); // Refresh lists
                } else {
                    displayMessage(messageContainer, resultNewBed.error || 'Error assigning new bed.', 'error');
                    // Potentially revert old bed status here if transfer failed after old bed was freed
                    // (This would require a more complex transaction logic on the backend)
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server during patient transfer. Check that backend is running.', 'error');
            }
        }

        // --- API Interaction Functions (Inventory) ---
        // Note: The inventory-form is not present in the current HTML. This function expects it to be added if needed.
        // document.getElementById('inventory-form').addEventListener('submit', async (event) => { /* ... */ });

        async function updateInventoryItemQuantity(itemId, newQuantity) {
            newQuantity = parseInt(newQuantity);
            if (isNaN(newQuantity) || newQuantity < 0) { displayMessage(messageContainer, 'Quantity must be a positive number.', 'error'); return; }
            const itemData = { quantite: newQuantity };
            try {
                const response = await fetch(`${API_BASE_URL}/inventaire/${itemId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(itemData), });
                const result = await response.json();
                if (response.ok) { displayMessage(messageContainer, result.message || 'Item quantity updated successfully!', 'success'); loadInventory(); }
                else { displayMessage(messageContainer, result.error || 'Error updating quantity.', 'error'); }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); }
        }

        async function loadInventory() {
            const inventoryListBody = document.getElementById('inventory-list');
            if (!inventoryListBody) return; // Prevent error if element doesn't exist
            inventoryListBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Loading inventory...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/inventaire`);
                const items = await response.json();
                if (response.ok) {
                    inventoryListBody.innerHTML = '';
                    if (items.length === 0) { inventoryListBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No items in inventory.</td></tr>'; return; }
                    items.forEach(item => {
                        const row = inventoryListBody.insertRow();
                        row.className = 'border-b last:border-b-0';
                        const quantityClass = item.quantite <= item.seuil_alerte && item.seuil_alerte > 0 ? 'bg-red-100 text-red-800 font-semibold' : '';
                        const actionsHtml = `
                            <input type="number" value="${item.quantite}" id="qty-${item.article_id}"
                                class="w-20 p-1 border rounded-md text-center text-sm ${['secretaire', 'lab_agent'].includes(currentUser.role) ? '' : 'hidden'}"
                                min="0">
                            <button onclick="updateInventoryItemQuantity(${item.article_id}, document.getElementById('qty-${item.article_id}').value)"
                                class="ml-2 bg-blue-500 hover:bg-blue-600 text-white text-xs px-2 py-1 rounded-md ${['secretaire', 'lab_agent'].includes(currentUser.role) ? '' : 'hidden'}">
                                Update
                            </button>
                            <button onclick="deleteInventoryItem(${item.article_id})" class="text-red-600 hover:text-red-900 ml-2 ${currentUser.role === 'secretaire' ? '' : 'hidden'}">Delete</button>
                        `;
                        row.innerHTML = `
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${item.article_id}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.nom_article}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm ${quantityClass}">${item.quantite}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.seuil_alerte}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.fournisseur || 'N/A'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-right text-sm font-medium">
                                ${actionsHtml}
                            </td>
                        `;
                    });
                } else { displayMessage(messageContainer, items.error || 'Error loading inventory.', 'error'); inventoryListBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Loading error.</td></tr>'; }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); inventoryListBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Could not connect to server.</td></tr>'; }
        }

        async function deleteInventoryItem(itemId) {
            if (!confirm('Are you sure you want to delete this inventory item?')) { return; }
            try {
                const response = await fetch(`${API_BASE_URL}/inventaire/${itemId}`, { method: 'DELETE', });
                const result = await response.json();
                if (response.ok) { displayMessage(messageContainer, result.message || 'Item deleted successfully!', 'success'); loadInventory(); }
                else { displayMessage(messageContainer, result.error || 'Error deleting item.', 'error'); }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); }
        }


        // --- API Interaction Functions (EMR - Diagnoses) ---
        document.getElementById('add-diagnosis-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const diagnosisData = {
                patient_id: parseInt(form.patient_id.value), medecin_id: form.medecin_id.value ? parseInt(form.medecin_id.value) : null,
                date_diagnostic: form.date_diagnostic.value, code_cim: form.code_cim.value || null,
                description: form.description.value, gravite: form.gravite.value || null
            };
            try {
                const response = await fetch(`${API_BASE_URL}/diagnoses`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(diagnosisData), });
                const result = await response.json();
                if (response.ok) { displayMessage(messageContainer, result.message || 'Diagnosis added successfully!', 'success'); form.reset(); loadDiagnoses(); }
                else { displayMessage(messageContainer, result.error || 'Error adding diagnosis.', 'error'); }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); }
        });

        async function loadDiagnoses(patientId = null) {
            const diagnosesListBody = document.getElementById('diagnoses-list');
            const patientDiagnosesList = document.getElementById('patient-diagnoses-list'); // For consolidated view

            if (!diagnosesListBody && !patientDiagnosesList) return;

            const url = patientId ? `${API_BASE_URL}/diagnoses?patient_id=${patientId}` : `${API_BASE_URL}/diagnoses`;

            const targetList = patientId ? patientDiagnosesList : diagnosesListBody;
            if (targetList) { // Check if targetList exists before trying to access innerHTML
                targetList.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Loading diagnoses...</td></tr>';
            }
            // Ensure both lists are updated if they exist, especially if a patient-specific view is loaded
            if (patientId && diagnosesListBody) { diagnosesListBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Loading diagnoses...</td></tr>'; }


            try {
                const response = await fetch(url);
                const diagnoses = await response.json();
                if (response.ok) {
                    if (targetList) { // Check again
                        targetList.innerHTML = '';
                        if (diagnoses.length === 0) { targetList.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No diagnoses found.</td></tr>'; }
                        diagnoses.forEach(diag => {
                            const row = targetList.insertRow();
                            row.className = 'border-b last:border-b-0';
                            // In the consolidated view, we don't need patient ID or internal ID for each row
                            const idCell = patientId ? `<td class="px-4 py-2 text-sm font-medium text-gray-900 hidden">${diag.diagnose_id || ''}</td>` : `<td class="px-4 py-2 text-sm font-medium text-gray-900">${diag.diagnose_id || ''}</td>`;
                            const patientIdCell = patientId ? `<td class="px-4 py-2 text-sm text-gray-700 hidden">${diag.patient_id}</td>` : `<td class="px-4 py-2 text-sm text-gray-700">${diag.patient_id}</td>`;
                            const actionsCell = patientId ? '' : `
                                <td class="px-4 py-2 text-right text-sm font-medium">
                                    <button onclick="deleteDiagnosis(${diag.diagnose_id})" class="text-red-600 hover:text-red-900 ml-2 ${currentUser.role === 'medecin' ? '' : 'hidden'}">Delete</button>
                                </td>
                            `;

                            row.innerHTML = `
                                ${idCell}
                                ${patientIdCell}
                                <td class="px-4 py-2 text-sm text-gray-700">${diag.date_diagnostic}</td>
                                <td class="px-4 py-2 text-sm text-gray-700">${diag.description} (CIM: ${diag.code_cim || 'N/A'})</td>
                                <td class="px-4 py-2 text-sm text-gray-700">${diag.gravite || 'N/A'}</td>
                                ${actionsCell}
                            `;
                        });
                        updateUIBasedOnRole(); // Re-apply role visibility for dynamically added elements
                    }
                } else {
                    displayMessage(messageContainer, diagnoses.error || 'Error loading diagnoses.', 'error');
                    if (targetList) { targetList.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Loading error.</td></tr>'; }
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
                if (targetList) { targetList.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Could not connect to server.</td></tr>'; }
            }
        }

        async function deleteDiagnosis(diagnosisId) {
            if (!confirm('Are you sure you want to delete this diagnosis?')) { return; }
            try {
                const response = await fetch(`${API_BASE_URL}/diagnoses/${diagnosisId}`, { method: 'DELETE', });
                const result = await response.json();
                if (response.ok) { displayMessage(messageContainer, result.message || 'Diagnosis deleted successfully!', 'success'); loadDiagnoses(); }
                else { displayMessage(messageContainer, result.error || 'Error deleting diagnosis.', 'error'); }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); }
        }

        // --- API Interaction Functions (EMR - Observations) ---
        document.getElementById('add-observation-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const observationData = {
                patient_id: parseInt(form.patient_id.value), medecin_id: form.medecin_id.value ? parseInt(form.medecin_id.value) : null,
                date_observation: form.date_observation.value || new Date().toISOString().slice(0, 19).replace('T', ' '),
                type_observation: form.type_observation.value, valeur: form.valeur.value,
                unite: form.unite.value || null, notes: form.notes.value || null
            };
            try {
                const response = await fetch(`${API_BASE_URL}/observations`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(observationData), });
                const result = await response.json();
                if (response.ok) { displayMessage(messageContainer, result.message || 'Observation added successfully!', 'success'); form.reset(); loadObservations(); }
                else { displayMessage(messageContainer, result.error || 'Error adding observation.', 'error'); }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); }
        });

        async function loadObservations(patientId = null) {
            const observationsListBody = document.getElementById('observations-list');
            const patientObservationsList = document.getElementById('patient-observations-list'); // For consolidated view

            if (!observationsListBody && !patientObservationsList) return;

            const url = patientId ? `${API_BASE_URL}/observations?patient_id=${patientId}` : `${API_BASE_URL}/observations`;

            const targetList = patientId ? patientObservationsList : observationsListBody;
            if (targetList) {
                targetList.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Loading observations...</td></tr>';
            }
             if (patientId && observationsListBody) { observationsListBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Loading observations...</td></tr>'; }

            try {
                const response = await fetch(url);
                const observations = await response.json();
                if (response.ok) {
                    if (targetList) {
                        targetList.innerHTML = '';
                        if (observations.length === 0) { targetList.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No observations found.</td></tr>'; }
                        observations.forEach(obs => {
                            const row = targetList.insertRow();
                            row.className = 'border-b last:border-b-0';

                            const idCell = patientId ? `<td class="px-4 py-2 text-sm font-medium text-gray-900 hidden">${obs.observation_id || ''}</td>` : `<td class="px-4 py-2 text-sm font-medium text-gray-900">${obs.observation_id || ''}</td>`;
                            const patientIdCell = patientId ? `<td class="px-4 py-2 text-sm text-gray-700 hidden">${obs.patient_id}</td>` : `<td class="px-4 py-2 text-sm text-gray-700">${obs.patient_id}</td>`;
                            const actionsCell = patientId ? '' : `
                                <td class="px-4 py-2 text-right text-sm font-medium">
                                    <button onclick="deleteObservation(${obs.observation_id})" class="text-red-600 hover:text-red-900 ml-2 ${currentUser.role === 'medecin' ? '' : 'hidden'}">Delete</button>
                                </td>
                            `;

                            row.innerHTML = `
                                ${idCell}
                                ${patientIdCell}
                                <td class="px-4 py-2 text-sm text-gray-700">${obs.date_observation}</td>
                                <td class="px-4 py-2 text-sm text-gray-700">${obs.type_observation}</td>
                                <td class="px-4 py-2 text-sm text-gray-700">${obs.valeur} ${obs.unite || ''}</td>
                                ${actionsCell}
                            `;
                        });
                        updateUIBasedOnRole(); // Re-apply role visibility for dynamically added elements
                    }
                } else {
                    displayMessage(messageContainer, observations.error || 'Error loading observations.', 'error');
                    if (targetList) { targetList.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Loading error.</td></tr>'; }
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
                if (targetList) { targetList.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Could not connect to server.</td></tr>'; }
            }
        }

        async function deleteObservation(observationId) {
            if (!confirm('Are you sure you want to delete this observation?')) { return; }
            try {
                const response = await fetch(`${API_BASE_URL}/observations/${observationId}`, { method: 'DELETE', });
                const result = await response.json();
                if (response.ok) { displayMessage(messageContainer, result.message || 'Observation deleted successfully!', 'success'); loadObservations(); }
                else { displayMessage(messageContainer, result.error || 'Error deleting observation.', 'error'); }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); }
        }

        // --- API Interaction Functions (Prescription) ---
        document.getElementById('add-prescription-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const prescriptionData = {
                patient_id: parseInt(form.patient_id.value),
                medecin_id: parseInt(form.medecin_id.value),
                medicament_id: form.medicament_id.value ? parseInt(form.medicament_id.value) : null,
                nom_medicament_texte: form.nom_medicament_texte.value || null,
                date_prescription: form.date_prescription.value,
                quantite: form.quantite.value || null,
                instructions: form.instructions.value || null
            };

            // Simple validation: either medicament_id or nom_medicament_texte must be present
            if (!prescriptionData.medicament_id && !prescriptionData.nom_medicament_texte) {
                displayMessage(messageContainer, 'Please specify a medication ID or medication name.', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/prescriptions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(prescriptionData),
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Prescription added successfully!', 'success');
                    form.reset();
                    // loadPrescriptions(); // Add a function to load prescriptions if you have one
                } else {
                    displayMessage(messageContainer, result.error || 'Error adding prescription.', 'error');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
            }
        });

        async function loadPrescriptions(patientId = null) {
            const patientPrescriptionsList = document.getElementById('patient-prescriptions-list'); // For consolidated view
            if (!patientPrescriptionsList) return;

            const url = patientId ? `${API_BASE_URL}/prescriptions?patient_id=${patientId}` : `${API_BASE_URL}/prescriptions`;

            patientPrescriptionsList.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Loading prescriptions...</td></tr>';

            try {
                const response = await fetch(url);
                const prescriptions = await response.json();
                if (response.ok) {
                    patientPrescriptionsList.innerHTML = '';
                    if (prescriptions.length === 0) {
                        patientPrescriptionsList.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No prescriptions found.</td></tr>';
                    }
                    prescriptions.forEach(p => {
                        const row = patientPrescriptionsList.insertRow();
                        row.className = 'border-b last:border-b-0';
                        const medicamentName = p.nom_medicament_ref || p.nom_medicament_texte || 'N/A';
                        const idCell = patientId ? `<td class="px-4 py-2 text-sm font-medium text-gray-900 hidden">${p.prescription_id || ''}</td>` : `<td class="px-4 py-2 text-sm font-medium text-gray-900">${p.prescription_id || ''}</td>`;
                        row.innerHTML = `
                            ${idCell}
                            <td class="px-4 py-2 text-sm text-gray-700">${p.date_prescription}</td>
                            <td class="px-4 py-2 text-sm text-gray-700">${medicamentName}</td>
                            <td class="px-4 py-2 text-sm text-gray-700">${p.quantite || 'N/A'}</td>
                            <td class="px-4 py-2 text-sm text-gray-700">${p.instructions || 'N/A'}</td>
                        `;
                    });
                } else {
                    displayMessage(messageContainer, prescriptions.error || 'Error loading prescriptions.', 'error');
                    patientPrescriptionsList.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Loading error.</td></tr>';
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
                patientPrescriptionsList.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Could not connect to server.</td></tr>';
            }
        }


        // --- API Interaction Functions (Lab Tests) ---
         document.getElementById('add-lab-test-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const labTestData = {
                patient_id: parseInt(form.patient_id.value),
                type_test: form.type_test.value,
                date_demande: form.date_demande.value,
                date_resultat: form.date_resultat.value || null,
                resultats: form.resultats.value || null,
                notes: form.notes.value || null,
                statut: form.statut.value
            };
            try {
                const response = await fetch(`${API_BASE_URL}/tests-laboratoire`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(labTestData),
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Lab test requested successfully!', 'success');
                    form.reset();
                    loadLabTests();
                } else {
                    displayMessage(messageContainer, result.error || 'Error requesting lab test.', 'error');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
            }
        });

        async function loadLabTests(patientId = null) {
            const labTestsListBody = document.getElementById('lab-tests-list');
            const patientLabTestsList = document.getElementById('patient-lab-tests-list'); // For consolidated view

            if (!labTestsListBody && !patientLabTestsList) return;

            const url = patientId ? `${API_BASE_URL}/tests-laboratoire?patient_id=${patientId}` : `${API_BASE_URL}/tests-laboratoire`;

            const targetList = patientId ? patientLabTestsList : labTestsListBody;
            if (targetList) {
                targetList.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Loading lab tests...</td></tr>';
            }
            if (patientId && labTestsListBody) { labTestsListBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Loading lab tests...</td></tr>'; }

            try {
                const response = await fetch(url);
                const tests = await response.json();
                if (response.ok) {
                    if (targetList) {
                        targetList.innerHTML = '';
                        if (tests.length === 0) { targetList.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No lab tests found.</td></tr>'; }
                        tests.forEach(test => {
                            const row = targetList.insertRow();
                            row.className = 'border-b last:border-b-0';
                            // Adjust visibility of results/actions controls for lab agent
                            const resultsActionsDisplay = currentUser.role === 'lab_agent' ? '' : 'hidden';

                            if (!patientId) { // Only show these columns in the general list, not consolidated
                                row.innerHTML = `
                                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${test.test_id}</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${test.patient_id}</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${test.type_test}</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${test.statut}</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${test.date_demande}</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-right text-sm font-medium">
                                        <textarea id="results-${test.test_id}" class="w-full p-1 border rounded-md text-sm mb-1 ${resultsActionsDisplay}" rows="2" placeholder="Results">${test.resultats || ''}</textarea>
                                        <select id="status-${test.test_id}" class="w-full p-1 border rounded-md text-sm mb-1 ${resultsActionsDisplay}">
                                            <option value="En attente" ${test.statut === 'En attente' ? 'selected' : ''}>Pending</option>
                                            <option value="En cours" ${test.statut === 'En cours' ? 'selected' : ''}>In Progress</option>
                                            <option value="Complété" ${test.statut === 'Complété' ? 'selected' : ''}>Completed</option>
                                            <option value="Annulé" ${test.statut === 'Annulé' ? 'selected' : ''}>Cancelled</option>
                                        </select>
                                        <input type="date" id="date-resultat-${test.test_id}" class="w-full p-1 border rounded-md text-sm mb-1 ${resultsActionsDisplay}" value="${test.date_resultat || ''}">
                                        <button onclick="updateLabTest(${test.test_id})" class="mt-1 bg-blue-500 hover:bg-blue-600 text-white text-xs px-2 py-1 rounded-md ${resultsActionsDisplay}">Update</button>
                                    </td>
                                `;
                            } else { // Consolidated view needs a simpler table structure
                                const idCell = patientId ? `<td class="px-4 py-2 text-sm font-medium text-gray-900 hidden">${test.test_id || ''}</td>` : `<td class="px-4 py-2 text-sm font-medium text-gray-900">${test.test_id || ''}</td>`;
                                row.innerHTML = `
                                    ${idCell}
                                    <td class="px-4 py-2 text-sm text-gray-700">${test.type_test}</td>
                                    <td class="px-4 py-2 text-sm text-gray-700">${test.date_demande}</td>
                                    <td class="px-4 py-2 text-sm text-gray-700">${test.date_resultat || 'N/A'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-700">${test.resultats || 'N/A'}</td>
                                    <td class="px-4 py-2 text-sm text-gray-700">${test.statut}</td>
                                `;
                            }
                        });
                        updateUIBasedOnRole(); // Re-apply role visibility for dynamically added elements
                    }
                } else { displayMessage(messageContainer, tests.error || 'Error loading lab tests.', 'error'); if (targetList) { targetList.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Loading error.</td></tr>'; } }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); if (targetList) { targetList.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Could not connect to server.</td></tr>'; } }
        }

        async function updateLabTest(testId) {
            const results = document.getElementById(`results-${testId}`).value;
            const status = document.getElementById(`status-${testId}`).value;
            const dateResultat = document.getElementById(`date-resultat-${testId}`).value;

            const updateData = {
                resultats: results,
                statut: status,
                date_resultat: dateResultat || null
            };

            try {
                const response = await fetch(`${API_BASE_URL}/tests-laboratoire/${testId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData),
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Lab test updated successfully!', 'success');
                    loadLabTests();
                } else {
                    displayMessage(messageContainer, result.error || 'Error updating lab test.', 'error');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
            }
        }


        // --- API Interaction Functions (Emergency Queue) ---
        document.getElementById('add-to-emergency-queue-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const queueData = {
                patient_id: parseInt(form.patient_id.value),
                notes: form.notes.value || null
            };
            try {
                const response = await fetch(`${API_BASE_URL}/emergency-queue`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(queueData),
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Patient added to queue!', 'success');
                    form.reset();
                    loadEmergencyQueue();
                } else {
                    displayMessage(messageContainer, result.error || 'Error adding to queue.', 'error');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
            }
        });

        async function loadEmergencyQueue() {
            const emergencyQueueListBody = document.getElementById('emergency-queue-list');
            if (!emergencyQueueListBody) return;
            emergencyQueueListBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Loading queue...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/emergency-queue`);
                const queueItems = await response.json();
                if (response.ok) {
                    emergencyQueueListBody.innerHTML = '';
                    if (queueItems.length === 0) {
                        emergencyQueueListBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No patients in queue.</td></tr>';
                        return;
                    }
                    queueItems.forEach(item => {
                        const row = emergencyQueueListBody.insertRow();
                        row.className = 'border-b last:border-b-0';
                        // Visibility control for update/delete actions
                        const actionsHtml = `
                            <select id="queue-status-${item.queue_id}" class="w-32 p-1 border rounded-md text-sm mb-1 ${['secretaire', 'medecin'].includes(currentUser.role) ? '' : 'hidden'}" onchange="updateEmergencyQueueStatus(${item.queue_id}, this.value)">
                                <option value="En attente" ${item.status === 'En attente' ? 'selected' : ''}>Pending</option>
                                <option value="Pris en charge" ${item.status === 'Pris en charge' ? 'selected' : ''}>Handled</option>
                                <option value="Terminé" ${item.status === 'Terminé' ? 'selected' : ''}>Completed</option>
                            </select>
                            <button onclick="deleteEmergencyQueueItem(${item.queue_id})" class="text-red-600 hover:text-red-900 ml-2 ${currentUser.role === 'secretaire' ? '' : 'hidden'}">Delete</button>
                        `;
                        row.innerHTML = `
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${item.queue_id}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.nom} ${item.prenom} (${item.patient_id})</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.entry_time}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.status}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.notes || 'N/A'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-right text-sm font-medium">
                                ${actionsHtml}
                            </td>
                        `;
                    });
                     updateUIBasedOnRole(); // Re-apply role visibility for dynamically added elements
                } else { displayMessage(messageContainer, queueItems.error || 'Error loading queue.', 'error'); emergencyQueueListBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Loading error.</td></tr>'; }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); emergencyQueueListBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Could not connect to server.</td></tr>'; }
        }

        async function updateEmergencyQueueStatus(queueId, newStatus) {
            const updateData = { status: newStatus };
            try {
                const response = await fetch(`${API_BASE_URL}/emergency-queue/${queueId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData),
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Queue status updated successfully!', 'success');
                    loadEmergencyQueue();
                } else {
                    displayMessage(messageContainer, result.error || 'Error updating queue status.', 'error');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
            }
        }

        async function deleteEmergencyQueueItem(queueId) {
            if (!confirm('Are you sure you want to remove this patient from the queue?')) { return; }
            try {
                const response = await fetch(`${API_BASE_URL}/emergency-queue/${queueId}`, { method: 'DELETE', });
                const result = await response.json();
                if (response.ok) { displayMessage(messageContainer, result.message || 'Patient removed from queue successfully!', 'success'); loadEmergencyQueue(); }
                else { displayMessage(messageContainer, result.error || 'Error removing patient from queue.', 'error'); }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); }
        }

        // --- EMR Functions (Electronic Medical Records) ---
        document.getElementById('emr_search_button').addEventListener('click', async () => {
            const searchTerm = document.getElementById('emr_search_patient').value.trim();
            const searchResultsContainer = document.getElementById('emr-search-results');
            searchResultsContainer.innerHTML = ''; // Clear previous results
            document.getElementById('patient-consolidated-view').classList.add('hidden'); // Hide consolidated view

            if (searchTerm.length < 2) {
                searchResultsContainer.innerHTML = '<p class="text-red-500">Please enter at least 2 characters for the search.</p>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/patients?search_term=${encodeURIComponent(searchTerm)}`);
                const patients = await response.json();

                if (response.ok) {
                    if (patients.length === 0) {
                        searchResultsContainer.innerHTML = '<p class="text-gray-600">No patients found with this search term.</p>';
                    } else {
                        const ul = document.createElement('ul');
                        ul.className = 'bg-white border border-gray-200 rounded-md shadow-sm divide-y divide-gray-100';
                        patients.forEach(patient => {
                            const li = document.createElement('li');
                            li.className = 'p-3 hover:bg-blue-50 cursor-pointer';
                            li.innerHTML = `<span class="font-medium">${patient.nom} ${patient.prenom}</span> (ID: ${patient.patient_id}, Born on: ${patient.date_naissance})`;
                            li.dataset.patientId = patient.patient_id;
                            li.addEventListener('click', () => {
                                loadConsolidatedPatientData(patient.patient_id);
                            });
                            ul.appendChild(li);
                        });
                        searchResultsContainer.appendChild(ul);
                    }
                } else {
                    displayMessage(messageContainer, patients.error || 'Error searching for patients.', 'error');
                }
            } catch (error) {
                console.error('Network or server error during patient search:', error);
                displayMessage(messageContainer, 'Could not connect to server for patient search.', 'error');
            }
        });

        async function loadConsolidatedPatientData(patientId) {
            const consolidatedView = document.getElementById('patient-consolidated-view');
            const currentPatientName = document.getElementById('current-patient-name');
            const currentPatientIdDisplay = document.getElementById('current-patient-id');
            const patientTimelineView = document.getElementById('patient-timeline-view');

            // Show loading indicators
            if (consolidatedView) consolidatedView.classList.add('hidden');
            displayMessage(messageContainer, 'Loading patient file...', 'info');
            if (patientTimelineView) patientTimelineView.innerHTML = '<p class="text-center text-gray-500">Loading history...</p>';

            try {
                // 1. Fetch patient general details
                const patientResponse = await fetch(`${API_BASE_URL}/patients/${patientId}`);
                if (!patientResponse.ok) {
                    throw new Error(`Patient not found (ID: ${patientId})`);
                }
                const patient = await patientResponse.json();

                // Update patient name and ID
                if (currentPatientName) currentPatientName.textContent = `${patient.nom} ${patient.prenom}`;
                if (currentPatientIdDisplay) currentPatientIdDisplay.textContent = patient.patient_id;

                // Update general patient info display
                if (document.getElementById('patient-dob-display')) document.getElementById('patient-dob-display').textContent = patient.date_naissance || 'N/A';
                if (document.getElementById('patient-genre-display')) document.getElementById('patient-genre-display').textContent = patient.genre || 'N/A';
                if (document.getElementById('patient-phone-display')) document.getElementById('patient-phone-display').textContent = patient.telephone || 'N/A';
                if (document.getElementById('patient-email-display')) document.getElementById('patient-email-display').textContent = patient.email || 'N/A';
                if (document.getElementById('patient-address-display')) document.getElementById('patient-address-display').textContent = patient.adresse || 'N/A';
                if (document.getElementById('patient-allergies-display')) document.getElementById('patient-allergies-display').textContent = patient.allergies || 'None';
                if (document.getElementById('patient-antecedents-display')) document.getElementById('patient-antecedents-display').textContent = patient.antecedents_chirurgicaux || 'None';
                if (document.getElementById('patient-insurance-display')) document.getElementById('patient-insurance-display').textContent = patient.info_assurance || 'N/A';

                // 2. Fetch all medical records for the timeline and tables
                const [diagnoses, observations, prescriptions, labTests] = await Promise.all([
                    fetch(`${API_BASE_URL}/diagnoses?patient_id=${patientId}`).then(res => res.json()),
                    fetch(`${API_BASE_URL}/observations?patient_id=${patientId}`).then(res => res.json()),
                    fetch(`${API_BASE_URL}/prescriptions?patient_id=${patientId}`).then(res => res.json()),
                    fetch(`${API_BASE_URL}/tests-laboratoire?patient_id=${patientId}`).then(res => res.json())
                ]);

                // Populate individual tables (re-using existing functions for consistency)
                await loadDiagnoses(patientId);
                await loadObservations(patientId);
                await loadPrescriptions(patientId);
                await loadLabTests(patientId);

                // Build and display the chronological timeline
                const timelineEvents = [];

                if (diagnoses && diagnoses.length > 0) {
                    diagnoses.forEach(d => timelineEvents.push({
                        date: d.date_diagnostic,
                        type: 'Diagnostic',
                        description: `${d.description} (CIM: ${d.code_cim || 'N/A'}) - Severity: ${d.gravite || 'N/A'}`
                    }));
                }
                if (observations && observations.length > 0) {
                    observations.forEach(o => timelineEvents.push({
                        date: o.date_observation,
                        type: 'Observation',
                        description: `${o.type_observation}: ${o.valeur} ${o.unite || ''} - Notes: ${o.notes || 'N/A'}`
                    }));
                }
                if (prescriptions && prescriptions.length > 0) {
                    prescriptions.forEach(p => timelineEvents.push({
                        date: p.date_prescription,
                        type: 'Prescription',
                        description: `Medication: ${p.nom_medicament_ref || p.nom_medicament_texte} - Qty: ${p.quantite || 'N/A'} - Instructions: ${p.instructions || 'N/A'}`
                    }));
                }
                if (labTests && labTests.length > 0) {
                    labTests.forEach(t => timelineEvents.push({
                        date: t.date_resultat || t.date_demande, // Prefer result date, fallback to request date
                        type: 'Lab Test',
                        description: `Type: ${t.type_test} - Results: ${t.resultats || 'Pending'} - Status: ${t.statut}`
                    }));
                }

                // Sort events by date in descending order (most recent first)
                timelineEvents.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (patientTimelineView) patientTimelineView.innerHTML = ''; // Clear loading message
                if (timelineEvents.length === 0) {
                    if (patientTimelineView) patientTimelineView.innerHTML = '<p class="text-center text-gray-500">No medical history found for this patient.</p>';
                } else {
                    timelineEvents.forEach(event => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'timeline-item';
                        itemDiv.innerHTML = `
                            <div class="timeline-date">${event.date}</div>
                            <div class="timeline-item-header">${event.type}</div>
                            <div class="timeline-item-body">${event.description}</div>
                        `;
                        if (patientTimelineView) patientTimelineView.appendChild(itemDiv);
                    });
                }


                if (consolidatedView) consolidatedView.classList.remove('hidden'); // Show the consolidated view
                displayMessage(messageContainer, `File for ${patient.nom} ${patient.prenom} loaded.`, 'success');
            } catch (error) {
                console.error('Error loading consolidated patient file:', error);
                displayMessage(messageContainer, `Error: ${error.message}`, 'error');
                if (consolidatedView) consolidatedView.classList.add('hidden'); // Ensure it's hidden on error
            }
        }

        // --- API Interaction Functions (Operations/Surgeries) ---
        document.getElementById('add-operation-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const operationData = {
                patient_id: parseInt(form.patient_id.value),
                medecin_id: parseInt(form.medecin_id.value),
                procedure_name: form.procedure_name.value,
                date_operation: form.date_operation.value,
                heure_debut: form.heure_debut.value,
                heure_fin: form.heure_fin.value || null,
                salle_operation: form.salle_operation.value || null,
                personnel_notes: form.personnel_notes.value || null,
                statut: form.statut.value || 'Planifiée'
            };

            try {
                const response = await fetch(`${API_BASE_URL}/operations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(operationData),
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Operation scheduled successfully!', 'success');
                    form.reset();
                    renderOperationCalendar(currentOperationCalendarDate.getFullYear(), currentOperationCalendarDate.getMonth()); // Re-render calendar
                } else {
                    displayMessage(messageContainer, result.error || 'Error scheduling operation.', 'error');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
            }
        });

        async function loadOperationsForCalendar(year, month) {
            try {
                const response = await fetch(`${API_BASE_URL}/operations`);
                const operations = await response.json();
                if (response.ok) {
                    displayOperationsOnCalendar(operations, year, month);
                } else {
                    displayMessage(messageContainer, operations.error || 'Error loading operations for calendar.', 'error');
                    // Ensure the calendar is cleared on error
                    document.getElementById('calendar-container').querySelectorAll('.calendar-day').forEach(day => {
                        const existingEvents = day.querySelectorAll('.operation-event');
                        existingEvents.forEach(event => event.remove());
                    });
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
                document.getElementById('calendar-container').querySelectorAll('.calendar-day').forEach(day => {
                    const existingEvents = day.querySelectorAll('.operation-event');
                    existingEvents.forEach(event => event.remove());
                });
            }
        }

        function renderOperationCalendar(year, month) {
            const calendarContainer = document.getElementById('calendar-container');
            const currentMonthYearDisplay = document.getElementById('current-month-year');
            if (!calendarContainer || !currentMonthYearDisplay) return;

            calendarContainer.innerHTML = `
                <div class="calendar-header-day">Lun</div>
                <div class="calendar-header-day">Mar</div>
                <div class="calendar-header-day">Mer</div>
                <div class="calendar-header-day">Jeu</div>
                <div class="calendar-header-day">Ven</div>
                <div class="calendar-header-day">Sam</div>
                <div class="calendar-header-day">Dim</div>
            `; // Clear and re-add headers

            const date = new Date(year, month, 1);
            currentMonthYearDisplay.textContent = date.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 for Sunday, 1 for Monday, ..., 6 for Saturday
            // Adjust to make Monday the first day (0 for Monday, 6 for Sunday)
            const startDay = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Add empty cells for days before the 1st
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarContainer.appendChild(emptyDay);
            }

            // Add cells for each day of the month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day relative group'; // Add group for potential hover effects
                dayCell.innerHTML = `<div class="calendar-day-number">${day}</div>`;
                dayCell.dataset.date = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // Highlight today's date
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayCell.classList.add('border-blue-500', 'border-2');
                }

                calendarContainer.appendChild(dayCell);
            }

            loadOperationsForCalendar(year, month);
        }

        function displayOperationsOnCalendar(operations, year, month) {
            const calendarDays = document.querySelectorAll('#calendar-container .calendar-day');
            const currentMonthStart = new Date(year, month, 1);
            const currentMonthEnd = new Date(year, month + 1, 0); // Last day of the current month

            calendarDays.forEach(dayCell => {
                // Clear any previously added operations
                const existingEvents = dayCell.querySelectorAll('.operation-event');
                existingEvents.forEach(event => event.remove());

                const dayDateStr = dayCell.dataset.date;
                if (!dayDateStr) return; // Skip empty cells

                const dayDate = new Date(dayDateStr);

                operations.forEach(op => {
                    const opDate = new Date(op.date_operation);
                    // Check if the operation date falls within the currently displayed day
                    if (opDate.getFullYear() === dayDate.getFullYear() &&
                        opDate.getMonth() === dayDate.getMonth() &&
                        opDate.getDate() === dayDate.getDate()) {

                        const eventDiv = document.createElement('div');
                        eventDiv.className = `operation-event group-hover:block ${op.statut === 'Annulée' ? 'cancelled' : ''} ${opDate < new Date().setHours(0,0,0,0) ? 'past' : ''}`;
                        eventDiv.textContent = `${op.heure_debut} ${op.procedure_name} (Patient: ${op.patient_id})`;
                        eventDiv.title = `ID: ${op.operation_id}\nPatient: ${op.patient_id}\nMédecin: ${op.medecin_id}\nProcédure: ${op.procedure_name}\nDate: ${op.date_operation}\nHeure: ${op.heure_debut} - ${op.heure_fin || 'N/A'}\nSalle: ${op.salle_operation || 'N/A'}\nStatut: ${op.statut}\nNotes: ${op.personnel_notes || 'N/A'}`;
                        
                        // Add click listener for editing (if authorized)
                        if (currentUser.role === 'secretaire' || currentUser.role === 'medecin') {
                            eventDiv.addEventListener('click', () => {
                                editOperationPrompt(op.operation_id, op.procedure_name, op.date_operation, op.heure_debut, op.salle_operation || '', op.personnel_notes || '', op.statut);
                            });
                        }
                        dayCell.appendChild(eventDiv);
                    }
                });
            });
        }


        document.getElementById('prev-month-button').addEventListener('click', () => {
            currentOperationCalendarDate.setMonth(currentOperationCalendarDate.getMonth() - 1);
            renderOperationCalendar(currentOperationCalendarDate.getFullYear(), currentOperationCalendarDate.getMonth());
        });

        document.getElementById('next-month-button').addEventListener('click', () => {
            currentOperationCalendarDate.setMonth(currentOperationCalendarDate.getMonth() + 1);
            renderOperationCalendar(currentOperationCalendarDate.getFullYear(), currentOperationCalendarDate.getMonth());
        });


        async function editOperationPrompt(id, procedure_name, date_operation, heure_debut, salle_operation, personnel_notes, statut) {
            if (!(currentUser.role === 'secretaire' || currentUser.role === 'medecin')) {
                displayMessage(messageContainer, "You are not authorized to edit operations.", 'error');
                return;
            }

            const newProcedureName = prompt('Procedure name:', procedure_name);
            if (newProcedureName === null) return; // Cancelled

            const newDate = prompt('New date (YYYY-MM-DD):', date_operation);
            if (newDate === null) return;

            const newHeureDebut = prompt('New start time (HH:MM):', heure_debut);
            if (newHeureDebut === null) return;

            const newSalle = prompt('New operating room:', salle_operation);
            if (newSalle === null) return;

            const newPersonnelNotes = prompt('Personnel/equipment notes:', personnel_notes);
            if (newPersonnelNotes === null) return;

            const newStatut = prompt('New status (Planifiée, En cours, Terminée, Annulée):', statut);
            if (newStatut === null || !['Planifiée', 'En cours', 'Terminée', 'Annulée'].includes(newStatut)) {
                 displayMessage(messageContainer, 'Invalid status. Please use "Planifiée", "En cours", "Terminée", or "Annulée".', 'error');
                return;
            }

            await updateOperation(id, {
                procedure_name: newProcedureName,
                date_operation: newDate,
                heure_debut: newHeureDebut,
                salle_operation: newSalle,
                personnel_notes: newPersonnelNotes,
                statut: newStatut
            });
        }


        async function updateOperation(operationId, updateData) {
            try {
                const response = await fetch(`${API_BASE_URL}/operations/${operationId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData),
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Operation updated successfully!', 'success');
                    renderOperationCalendar(currentOperationCalendarDate.getFullYear(), currentOperationCalendarDate.getMonth()); // Re-render calendar
                } else {
                    displayMessage(messageContainer, result.error || 'Error updating operation.', 'error');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
            }
        }

        async function cancelOperation(operationId) {
            if (!(currentUser.role === 'secretaire' || currentUser.role === 'medecin')) {
                displayMessage(messageContainer, "You are not authorized to cancel operations.", 'error');
                return;
            }
            if (!confirm('Are you sure you want to CANCEL this operation?')) { return; }
            try {
                const response = await fetch(`${API_BASE_URL}/operations/${operationId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ statut: 'Annulée' }),
                });
                const result = await response.json();
                if (response.ok) { displayMessage(messageContainer, result.message || 'Operation cancelled successfully!', 'success'); renderOperationCalendar(currentOperationCalendarDate.getFullYear(), currentOperationCalendarDate.getMonth()); }
                else { displayMessage(messageContainer, result.error || 'Error cancelling operation.', 'error'); }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); }
        }

        // --- API Interaction Functions (Doctor Availabilities) ---
        document.getElementById('add-availability-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const availabilityData = {
                medecin_id: parseInt(form.medecin_id.value),
                date_disponibilite: form.date_disponibilite.value,
                heure_debut: form.heure_debut.value,
                heure_fin: form.heure_fin.value,
                statut: form.statut.value,
                notes: form.notes.value || null
            };

            // Basic validation
            if (!availabilityData.medecin_id || !availabilityData.date_disponibilite || !availabilityData.heure_debut || !availabilityData.heure_fin) {
                displayMessage(messageContainer, 'Please fill in all required fields (doctor, date, times).', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/disponibilites`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(availabilityData),
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Availability added successfully!', 'success');
                    form.reset();
                    loadAvailabilities(); // Refresh the list
                } else {
                    displayMessage(messageContainer, result.error || 'Error adding availability.', 'error');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
            }
        });

        async function loadAvailabilities() {
            const availabilitiesListBody = document.getElementById('availabilities-list');
            if (!availabilitiesListBody) return;
            availabilitiesListBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Loading availabilities...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/disponibilites`);
                const availabilities = await response.json();
                if (response.ok) {
                    availabilitiesListBody.innerHTML = '';
                    if (availabilities.length === 0) {
                        availabilitiesListBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No availabilities registered.</td></tr>';
                        return;
                    }
                    availabilities.forEach(item => {
                        const row = availabilitiesListBody.insertRow();
                        row.className = 'border-b last:border-b-0';
                        row.innerHTML = `
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${item.disponibilite_id}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.nom} ${item.prenom} (ID: ${item.medecin_id})</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.date_disponibilite}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.heure_debut}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.heure_fin}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                    ${item.statut === 'Disponible' ? 'bg-green-100 text-green-800' :
                                      item.statut === 'Occupé' ? 'bg-yellow-100 text-yellow-800' :
                                      item.statut === 'Annulé' ? 'bg-red-100 text-red-800' :
                                      'bg-gray-100 text-gray-800'}">
                                    ${item.statut}
                                </span>
                            </td>
                            <td class="px-4 py-2 whitespace-nowrap text-right text-sm font-medium" data-roles-visibility="secretaire">
                                <button onclick="editAvailabilityPrompt(${item.disponibilite_id}, ${item.medecin_id}, '${item.date_disponibilite}', '${item.heure_debut}', '${item.heure_fin}', '${item.statut}', '${item.notes || ''}')" class="text-indigo-600 hover:text-indigo-900 ml-2">Edit</button>
                                <button onclick="deleteAvailability(${item.disponibilite_id})" class="text-red-600 hover:text-red-900 ml-2">Delete</button>
                            </td>
                        `;
                    });
                    updateUIBasedOnRole(); // Re-apply role visibility for dynamically added elements
                } else { displayMessage(messageContainer, availabilities.error || 'Error loading availabilities.', 'error'); availabilitiesListBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">Loading error.</td></tr>'; }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); availabilitiesListBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">Could not connect to server.</td></tr>'; }
        }

        async function editAvailabilityPrompt(id, medecin_id, date_disponibilite, heure_debut, heure_fin, statut, notes) {
            const newDate = prompt('New availability date (YYYY-MM-DD):', date_disponibilite);
            if (newDate === null) return;

            const newHeureDebut = prompt('New start time (HH:MM):', heure_debut);
            if (newHeureDebut === null) return;

            const newHeureFin = prompt('New end time (HH:MM):', heure_fin);
            if (newHeureFin === null) return;

            const newStatut = prompt('New status (Disponible, Occupé, Annulé):', statut);
            if (newStatut === null || !['Disponible', 'Occupé', 'Annulé'].includes(newStatut)) {
                displayMessage(messageContainer, 'Invalid status. Please use "Disponible", "Occupé", or "Annulé".', 'error');
                return;
            }

            const newNotes = prompt('New notes:', notes);
            if (newNotes === null) return;

            await updateAvailability(id, {
                medecin_id: medecin_id, // Keep same doctor for update, or allow changing if needed
                date_disponibilite: newDate,
                heure_debut: newHeureDebut,
                heure_fin: newHeureFin,
                statut: newStatut,
                notes: newNotes
            });
        }

        async function updateAvailability(availabilityId, updateData) {
            try {
                const response = await fetch(`${API_BASE_URL}/disponibilites/${availabilityId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData),
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'Availability updated successfully!', 'success');
                    loadAvailabilities();
                } else {
                    displayMessage(messageContainer, result.error || 'Error updating availability.', 'error');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
            }
        }

        async function deleteAvailability(availabilityId) {
            if (!confirm('Are you sure you want to delete this availability?')) { return; }
            try {
                const response = await fetch(`${API_BASE_URL}/disponibilites/${availabilityId}`, { method: 'DELETE', });
                const result = await response.json();
                if (response.ok) { displayMessage(messageContainer, result.message || 'Availability deleted successfully!', 'success'); loadAvailabilities(); }
                else { displayMessage(messageContainer, result.error || 'Error deleting availability.', 'error'); }
            } catch (error) { console.error('Network or server error:', error); displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error'); }
        }

        // --- Appointment Calendar Functions ---

        async function loadAppointmentsForCalendar(year, month) {
            try {
                const response = await fetch(`${API_BASE_URL}/appointments`);
                const appointments = await response.json();
                if (response.ok) {
                    // Filter appointments to only include those in the current month/year
                    const filteredAppointments = appointments.filter(appt => {
                        const apptDate = new Date(appt.date_heure);
                        return apptDate.getFullYear() === year && apptDate.getMonth() === month;
                    });
                    displayAppointmentsOnCalendar(filteredAppointments, year, month);
                } else {
                    displayMessage(messageContainer, appointments.error || 'Error loading appointments for calendar.', 'error');
                    // Ensure the calendar is cleared on error
                    document.getElementById('appointments-calendar-container').querySelectorAll('.calendar-day').forEach(day => {
                        const existingEvents = day.querySelectorAll('.appointment-event');
                        existingEvents.forEach(event => event.remove());
                    });
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running.', 'error');
                 document.getElementById('appointments-calendar-container').querySelectorAll('.calendar-day').forEach(day => {
                    const existingEvents = day.querySelectorAll('.appointment-event');
                    existingEvents.forEach(event => event.remove());
                });
            }
        }

        function renderAppointmentsCalendar(year, month) {
            const calendarContainer = document.getElementById('appointments-calendar-container');
            const currentMonthYearDisplay = document.getElementById('current-appt-month-year');
            if (!calendarContainer || !currentMonthYearDisplay) return;

            // Clear and re-add headers if they were removed (ensure they are always there)
            calendarContainer.innerHTML = `
                <div class="calendar-header-day">Lun</div>
                <div class="calendar-header-day">Mar</div>
                <div class="calendar-header-day">Mer</div>
                <div class="calendar-header-day">Jeu</div>
                <div class="calendar-header-day">Ven</div>
                <div class="calendar-header-day">Sam</div>
                <div class="calendar-header-day">Dim</div>
            `;

            const date = new Date(year, month, 1);
            currentMonthYearDisplay.textContent = date.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 for Sunday, 1 for Monday, ..., 6 for Saturday
            const startDay = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1; // Adjust to make Monday the first day

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Add empty cells for days before the 1st
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarContainer.appendChild(emptyDay);
            }

            // Add cells for each day of the month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day relative group';
                dayCell.innerHTML = `<div class="calendar-day-number">${day}</div>`;
                dayCell.dataset.date = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // Highlight today's date
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayCell.classList.add('border-red-500', 'border-2'); // Different highlight color for appointments
                }

                calendarContainer.appendChild(dayCell);
            }

            loadAppointmentsForCalendar(year, month);
        }

        function displayAppointmentsOnCalendar(appointments, year, month) {
            const calendarDays = document.querySelectorAll('#appointments-calendar-container .calendar-day');

            calendarDays.forEach(dayCell => {
                // Clear any previously added appointments
                const existingEvents = dayCell.querySelectorAll('.appointment-event');
                existingEvents.forEach(event => event.remove());

                const dayDateStr = dayCell.dataset.date;
                if (!dayDateStr) return; // Skip empty cells

                const dayDate = new Date(dayDateStr);

                appointments.forEach(appt => {
                    const apptDate = new Date(appt.date_heure);
                    // Check if the appointment date falls within the currently displayed day
                    if (apptDate.getFullYear() === dayDate.getFullYear() &&
                        apptDate.getMonth() === dayDate.getMonth() &&
                        apptDate.getDate() === dayDate.getDate()) {

                        const eventDiv = document.createElement('div');
                        let statusClass = '';
                        if (appt.statut === 'Annulé') {
                            statusClass = 'cancelled';
                        } else if (appt.statut === 'Terminé') {
                            statusClass = 'completed';
                        } else if (appt.statut === 'Reporté') {
                             statusClass = 'rescheduled';
                        }
                        // Check if the appointment is in the past
                        if (apptDate < new Date().setHours(0,0,0,0) && appt.statut !== 'Terminé' && appt.statut !== 'Annulé' && appt.statut !== 'Reporté') { // Also exclude rescheduled from 'past' visual unless explicitly desired
                            statusClass += ' past'; // Use a generic 'past' class or a specific one if needed
                        }


                        eventDiv.className = `appointment-event group-hover:block ${statusClass}`;
                        eventDiv.textContent = `${appt.date_heure.split(' ')[1].substring(0, 5)} Patient: ${appt.patient_id}`; // Display time and patient
                        eventDiv.title = `ID: ${appt.rendezvous_id}\nPatient: ${appt.patient_id}\nMédecin: ${appt.medecin_id || 'N/A'}\nDate & Heure: ${appt.date_heure}\nRaison: ${appt.raison}\nStatut: ${appt.statut}`;
                        
                        // Add click listener for editing (if authorized by role)
                        if (currentUser.role === 'secretaire') { // Only secretary can edit directly from calendar
                            eventDiv.addEventListener('click', () => {
                                // For simplicity, we'll use the existing reschedule/cancel for now,
                                // but a dedicated edit function would be better.
                                const action = prompt(`Appointment ID: ${appt.rendezvous_id}\nPatient: ${appt.patient_id}\nReason: ${appt.raison}\n\nDo you want to Reschedule, Cancel, or Complete this appointment? (Type 'reschedule', 'cancel', or 'complete')`);
                                if (action && action.toLowerCase() === 'reschedule') {
                                    rescheduleAppointment(appt.rendezvous_id);
                                } else if (action && action.toLowerCase() === 'cancel') {
                                    cancelAppointment(appt.rendezvous_id);
                                } else if (action && action.toLowerCase() === 'complete') {
                                     completeAppointment(appt.rendezvous_id);
                                }
                            });
                        }
                        dayCell.appendChild(eventDiv);
                    }
                });
            });
        }

        document.getElementById('appt-prev-month-button').addEventListener('click', () => {
            currentAppointmentCalendarDate.setMonth(currentAppointmentCalendarDate.getMonth() - 1);
            renderAppointmentsCalendar(currentAppointmentCalendarDate.getFullYear(), currentAppointmentCalendarDate.getMonth());
        });

        document.getElementById('appt-next-month-button').addEventListener('click', () => {
            currentAppointmentCalendarDate.setMonth(currentAppointmentCalendarDate.getMonth() + 1);
            renderAppointmentsCalendar(currentAppointmentCalendarDate.getFullYear(), currentAppointmentCalendarDate.getMonth());
        });

        // --- API Interaction Functions (User Management) ---
        document.getElementById('add-user-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const userData = {
                username: form.username.value,
                password: form.password.value, // Password will be hashed on backend
                role: form.role.value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData),
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'User created successfully!', 'success');
                    form.reset();
                    loadUsers(); // Refresh the list
                } else {
                    displayMessage(messageContainer, result.error || 'Error creating user.', 'error');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running and /users endpoint is configured.', 'error');
            }
        });

        async function loadUsers() {
            const usersListBody = document.getElementById('users-list');
            if (!usersListBody) return;
            usersListBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Loading users...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/users`);
                const users = await response.json();
                if (response.ok) {
                    usersListBody.innerHTML = '';
                    if (users.length === 0) {
                        usersListBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No users found.</td></tr>';
                        return;
                    }
                    users.forEach(user => {
                        const row = usersListBody.insertRow();
                        row.className = 'border-b last:border-b-0';
                        row.innerHTML = `
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${user.user_id}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${user.username}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${user.role}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-right text-sm font-medium" data-roles-visibility="admin">
                                <button onclick="editUserPrompt(${user.user_id}, '${user.username}', '${user.role}')" class="text-indigo-600 hover:text-indigo-900 ml-2">Edit</button>
                                <button onclick="deleteUser(${user.user_id})" class="text-red-600 hover:text-red-900 ml-2">Delete</button>
                                <button onclick="resetUserPasswordPrompt(${user.user_id}, '${user.username}')" class="text-blue-600 hover:text-blue-900 ml-2">Reset Password</button>
                            </td>
                        `;
                    });
                    updateUIBasedOnRole(); // Re-apply role visibility for dynamically added elements
                } else {
                    displayMessage(messageContainer, users.error || 'Error loading users.', 'error');
                    usersListBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Loading error.</td></tr>';
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running and /users endpoint is configured.', 'error');
                usersListBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Could not connect to server.</td></tr>';
            }
        }

        async function editUserPrompt(userId, currentUsername, currentRole) {
            if (currentUser.role !== 'admin') {
                displayMessage(messageContainer, "You are not authorized to edit users.", 'error');
                return;
            }
            const newUsername = prompt('Edit Username:', currentUsername);
            if (newUsername === null) return; // User cancelled

            const newRole = prompt(`Edit Role for ${newUsername} (admin, secretaire, medecin, lab_agent):`, currentRole);
            if (newRole === null || !['admin', 'secretaire', 'medecin', 'lab_agent'].includes(newRole)) {
                displayMessage(messageContainer, 'Invalid role. Please use admin, secretaire, medecin, or lab_agent.', 'error');
                return;
            }

            await updateUser(userId, { username: newUsername, role: newRole });
        }

        async function resetUserPasswordPrompt(userId, username) {
            if (currentUser.role !== 'admin') {
                displayMessage(messageContainer, "You are not authorized to reset passwords.", 'error');
                return;
            }
            const newPassword = prompt(`Enter new password for ${username}:`);
            if (newPassword === null || newPassword.length < 6) { // Minimum password length
                displayMessage(messageContainer, 'Password reset cancelled or password too short (min 6 characters).', 'error');
                return;
            }
            if (!confirm(`Are you sure you want to reset the password for ${username}?`)) {
                return;
            }

            await updateUser(userId, { password: newPassword });
        }

        async function updateUser(userId, updateData) {
            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData),
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'User updated successfully!', 'success');
                    loadUsers(); // Refresh the list
                    // If the current user's role was changed, force a re-login to update permissions
                    if (userId === currentUser.user_id && updateData.role && updateData.role !== currentUser.role) {
                         alert("Your role has been updated. Please log in again for changes to take effect.");
                         logoutButton.click(); // Force logout
                    }
                } else {
                    displayMessage(messageContainer, result.error || 'Error updating user.', 'error');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running and /users endpoint is configured.', 'error');
            }
        }

        async function deleteUser(userId) {
            if (currentUser.role !== 'admin') {
                displayMessage(messageContainer, "You are not authorized to delete users.", 'error');
                return;
            }
            if (userId === currentUser.user_id) {
                displayMessage(messageContainer, "You cannot delete your own user account while logged in.", 'error');
                return;
            }
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    method: 'DELETE',
                });
                const result = await response.json();
                if (response.ok) {
                    displayMessage(messageContainer, result.message || 'User deleted successfully!', 'success');
                    loadUsers(); // Refresh the list
                } else {
                    displayMessage(messageContainer, result.error || 'Error deleting user.', 'error');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayMessage(messageContainer, 'Could not connect to server. Check that backend is running and /users endpoint is configured.', 'error');
            }
        }
    </script>
</body>
</html>
